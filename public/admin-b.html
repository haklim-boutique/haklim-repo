<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --primary-dark: #1d4ed8;
            --sidebar-bg: #1e293b;
            --sidebar-text: #f8fafc;
            --header-bg: #ffffff;
            --header-text: #1e293b;
            --content-bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border-radius: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            --highlight: #f97316;
            --highlight-light: #ffedd5;
            --taupe: #483C32;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--content-bg);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--header-bg);
            box-shadow: var(--shadow-sm);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            height: 64px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .hamburger {
            font-size: 1.25rem;
            color: var(--text-light);
            cursor: pointer;
            display: none;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .hamburger:hover {
            background-color: var(--content-bg);
        }

        .logo {
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            color: var(--primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-light);
        }

        .user-name {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 0.5rem 0;
            min-width: 200px;
            z-index: 10;
            display: none;
        }

        .user-profile:hover .user-dropdown {
            display: block;
        }

        .dropdown-item {
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .dropdown-item:hover {
            background-color: var(--content-bg);
            color: var(--primary);
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--content-bg);
            margin: 0.25rem 0;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
        }

        /* Sidebar - Simplified */
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            transition: all 0.3s ease;
            height: calc(100vh - 64px);
            position: sticky;
            top: 64px;
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-menu {
            padding: 1rem 0;
            flex: 1;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.125rem;
            font-size: 0.875rem;
            position: relative;
            color: var(--sidebar-text);
            text-decoration: none;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 500;
        }

        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            border-radius: 0 3px 3px 0;
        }

        .menu-item i {
            margin-right: 0.75rem;
            font-size: 1rem;
            width: 20px;
            text-align: center;
            opacity: 0.8;
        }

        .menu-item.active i {
            opacity: 1;
        }

        .menu-item span {
            flex: 1;
        }

        .menu-badge {
            background: var(--primary);
            color: white;
            border-radius: 9999px;
            font-size: 0.6875rem;
            padding: 0.125rem 0.375rem;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--sidebar-text);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .logout-btn i {
            margin-right: 0.75rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 1.5rem;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .content-title i {
            color: var(--primary);
        }

        .content-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .summary-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .summary-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .summary-card:nth-child(1) .summary-icon {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .summary-card:nth-child(2) .summary-icon {
            background-color: var(--success-light);
            color: var(--success);
        }

        .summary-card:nth-child(3) .summary-icon {
            background-color: var(--info-light);
            color: var(--info);
        }

        .summary-card:nth-child(4) .summary-icon {
            background-color: var(--highlight-light);
            color: var(--highlight);
        }

        .summary-trend {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }

        .trend-up {
            background-color: var(--success-light);
            color: var(--success);
        }

        .trend-down {
            background-color: var(--danger-light);
            color: var(--danger);
        }

        .trend-neutral {
            background-color: var(--content-bg);
            color: var(--text-light);
        }

        .summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0.25rem 0;
            color: var(--text-dark);
        }

        .summary-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-label {
            font-size: 0.875rem;
            color: var(--text-light);
            white-space: nowrap;
        }

        .filter-select, .filter-input {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            min-width: 160px;
        }

        .filter-select:hover, .filter-input:hover {
            border-color: var(--primary);
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .filter-input {
            min-width: 240px;
            padding: 0.5rem 1rem;
        }

        /* Tables - Enhanced */
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            background: var(--card-bg);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th {
            background: var(--content-bg);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background-color: var(--content-bg);
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .status i {
            margin-right: 0.25rem;
            font-size: 0.625rem;
        }

        .status.pending {
            background: var(--warning-light);
            color: var(--warning);
        }

        .status.completed {
            background: var(--success-light);
            color: var(--success);
        }

        .status.cancelled {
            background: var(--danger-light);
            color: var(--danger);
        }

        .status.processing {
            background: var(--info-light);
            color: var(--info);
        }

        .status.active {
            background: var(--success-light);
            color: var(--success);
        }

        .status.inactive {
            background: var(--content-bg);
            color: var(--text-light);
        }

        .status.paid {
            background: var(--success-light);
            color: var(--success);
        }

        .status.pending-payment {
            background: var(--warning-light);
            color: var(--warning);
        }

        .status.withdrawal-requested {
            background: var(--info-light);
            color: var(--info);
        }

        .status.shipped {
            background: var(--info-light);
            color: var(--info);
        }

        /* Table Actions - Consistent Style */
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: transparent;
            color: var(--text-dark);
        }

        .action-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }

        .action-btn i {
            font-size: 0.875rem;
        }

        .action-btn .tooltip {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-dark);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .action-btn:hover .tooltip {
            opacity: 1;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn i {
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary-light);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #0d9c6e;
            border-color: #0d9c6e;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
            border-color: #d97706;
        }

        .btn-secondary {
            background: var(--content-bg);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Chart Container */
        .chart-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            height: 360px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-period-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-period {
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius);
            background: var(--content-bg);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .chart-period:hover {
            background: #e2e8f0;
        }

        .chart-period.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 1rem;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .modal-lg {
            max-width: 1000px;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--danger);
            background: var(--danger-light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* Order Details */
        .order-details {
            margin-bottom: 1.5rem;
        }

        .detail-row {
            display: flex;
            margin-bottom: 1rem;
        }

        .detail-label {
            font-weight: 500;
            width: 160px;
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .detail-value {
            flex: 1;
            font-size: 0.875rem;
        }

        .order-items {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .order-items th {
            background: var(--content-bg);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .order-items td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .order-items tfoot td {
            font-weight: 500;
            padding: 0.75rem 1rem;
        }

        .order-items tfoot tr:last-child td {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Forms */
        .form-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: 1.25rem;
            display: flex;
            flex-direction: column;
        }

        .form-check{
            flex: 1;
            margin-bottom: 0;
        }

        .form-check > input[type="radio"] {
            appearance: radio;
            box-sizing: border-box;
            margin: 3px 3px 0 5px;
            padding: initial;
            border: initial;
            width: auto;
            height: auto;
        }


        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group > p{
            color: var(--text-light);
        }

        .form-label-required::after {
            content: '*';
            color: var(--danger);
            margin-left: 0.25rem;
        }

        .modal-body input,
        .modal-body textarea,
        .modal-body select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background-color: white;
            color: var(--text-dark);
        }

        .modal-body input:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-control {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-select {
            width: 100%;
            padding: 0.625rem 2.5rem 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23647d8b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-check-input {
            width: 1rem;
            height: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            appearance: none;
            position: relative;
            cursor: pointer;
        }

        .form-check-input:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .form-check-input:checked::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0.5rem;
            height: 0.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            transform: translate(-50%, -50%);
        }

        .form-check-label {
            font-size: 0.875rem;
            color: var(--text-dark);
            cursor: pointer;
        }

        

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: flex;
            width: 50px;
            height: 24px;
            white-space: nowrap;
        }

        .toggle-switch > span:nth-last-child(1) {
            margin-left: 3.8rem;
            display: flex;
            
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Password Input */
        .password-input {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 0.25rem;
        }

        /* Media Upload */
        .media-upload {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .media-upload:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .media-upload p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        /* Media Preview */
        .media-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .media-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px dashed var(--border-color);
        }

        .media-preview img,
        .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview .delete-media {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.625rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .media-preview:hover .delete-media {
            opacity: 1;
        }

        /* Features List */
        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .feature-tag {
            background: var(--primary-light);
            color: var(--primary);
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius);
            font-size: 0.8125rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .feature-tag .delete-feature {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
        }

        /* Variants Section */
        .variants-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .color-variants {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .color-variant {
            background: var(--content-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            width: 100%;
            max-width: 300px;
        }

        .color-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .color-name {
            font-weight: 500;
        }

        .color-actions {
            display: flex;
            gap: 0.5rem;
        }

        .sizes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .size-tag {
            background: var(--content-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .size-tag .delete-size {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
        }

        .add-size-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 400px;
        }

        .toast {
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
            background: var(--card-bg);
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.info {
            border-left-color: var(--info);
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast.info .toast-icon {
            color: var(--info);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-dark);
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem;
            margin-left: 0.5rem;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            background: rgba(0, 0, 0, 0.1);
        }

        .toast-progress-bar {
            height: 100%;
            background: currentColor;
            animation: progressBar 5s linear forwards;
        }

        .toast.success .toast-progress-bar {
            background: var(--success);
        }

        .toast.error .toast-progress-bar {
            background: var(--danger);
        }

        .toast.warning .toast-progress-bar {
            background: var(--warning);
        }

        .toast.info .toast-progress-bar {
            background: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes progressBar {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
            margin-right: 0.5rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Accounts Section */
        .balance-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0.5rem 0;
        }

        .balance-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .balance-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .transaction-date {
            font-size: 0.8125rem;
            color: var(--text-light);
        }

        .transaction-amount {
            font-weight: 500;
        }

        .transaction-amount.positive {
            color: var(--success);
        }

        .transaction-amount.negative {
            color: var(--danger);
        }

        /* Transaction type styling */
.transaction-credit {
    color: var(--success);
    background-color: var(--success-light);
}

.transaction-debit {
    color: var(--danger);
    background-color: var(--danger-light);
}

.transaction-cod {
    color: var(--info);
    background-color: var(--info-light);
}

/* Amount styling */
.amount-positive {
    color: var(--success);
    font-weight: 600;
}

.amount-negative {
    color: var(--danger);
    font-weight: 600;
}

.amount-neutral {
    color: var(--info);
    font-weight: 600;
}

/* Table icon styling */
.data-table th i {
    margin-right: 0.5rem;
    color: var(--primary);
}

        /* Subscription Plans */
        .plans-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .plan-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .plan-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .plan-card.recommended {
            border: 1px solid var(--primary);
            position: relative;
        }

        .plan-badge {
            position: absolute;
            top: -0.75rem;
            right: 1.5rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .plan-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .plan-period {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .plan-features {
            margin: 1.5rem 0;
        }

        .plan-feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .plan-feature i {
            color: var(--success);
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .setting-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .setting-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-dark);
            font-size: 1.125rem;
        }

        /* Color Picker */
        .color-picker {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--text-dark);
            transform: scale(1.1);
        }

        /* Theme Preview */
        .theme-preview {
            width: 100%;
            height: 200px;
            border-radius: var(--border-radius);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }

        .theme-preview-header {
            height: 40px;
            background: var(--primary);
            display: flex;
            align-items: center;
            padding: 0 1rem;
        }

        .theme-preview-sidebar {
            position: absolute;
            left: 0;
            top: 40px;
            bottom: 0;
            width: 60px;
            background: var(--sidebar-bg);
        }

        .theme-preview-content {
            position: absolute;
            left: 60px;
            top: 40px;
            right: 0;
            bottom: 0;
            padding: 1rem;
            background: var(--content-bg);
        }

        .theme-preview-card {
            background: var(--card-bg);
            border-radius: calc(var(--border-radius) - 0.25rem);
            height: 100%;
            box-shadow: var(--shadow);
            padding: 1rem;
        }

        /* Payment Method */
        .payment-method {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .payment-method-icon {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .payment-method-details {
            flex: 1;
        }

        .payment-method-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .payment-method-info {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .payment-method-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .hamburger {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: -240px;
                top: 64px;
                height: calc(100vh - 64px);
                z-index: 40;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }

            .header-right {
                gap: 1rem;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .content-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .filter-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-group {
                width: 100%;
            }

            .filter-select, .filter-input {
                width: 100%;
            }

            .modal-lg, .modal-xl {
                max-width: 100%;
            }

            .form-row {
                flex-direction: column;
                gap: 1rem;
            }
        }

        @media (max-width: 576px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .plans-container {
                grid-template-columns: 1fr;
            }

            .balance-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .modal-body {
                padding: 1rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="hamburger" id="hamburger">
                <i class="fas fa-bars"></i>
            </div>
            <div class="logo">
                <i class="fas fa-store-alt logo-icon"></i>
                <span>Haklim Admin</span>
            </div>
        </div>
        <div class="header-right">
            <div class="user-profile">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/Default_pfp.jpg/120px-Default_pfp.jpg" alt="Admin" class="user-avatar">
                <!--<span class="user-name">Merchant</span>-->
                <div class="user-dropdown">
                    <a href="#" class="dropdown-item">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                    <a href="#" class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar - Simplified -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" data-target="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="menu-item" data-target="orders">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Orders</span>
                    <span class="menu-badge">0</span>
                </a>
                <a href="#" class="menu-item" data-target="products">
                    <i class="fas fa-box-open"></i>
                    <span>Products</span>
                </a>
                <a href="#" class="menu-item" data-target="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="menu-item" data-target="accounts">
                    <i class="fas fa-wallet"></i>
                    <span>Accounts</span>
                </a>
                <a href="#" class="menu-item" data-target="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
            <div class="sidebar-footer">
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Content -->
            <div class="content-section" id="dashboard">
                <div class="content-header">
                    <h1 class="content-title">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard Overview
                    </h1>
                    <div class="filter-bar">
                        <div class="filter-group">
                            <span class="filter-label">Period:</span>
                            <select class="filter-select" id="timeFilter">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="summary-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">0</div>
                        <div class="summary-label">New Orders</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="summary-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">$0</div>
                        <div class="summary-label">Revenue</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="summary-trend trend-neutral">
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">0</div>
                        <div class="summary-label">New Customers</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="summary-trend trend-down">
                                <i class="fas fa-arrow-down"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">0</div>
                        <div class="summary-label">Low Stock Items</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Sales Performance</div>
                        <div class="chart-period-selector">
                            <div class="chart-period active" data-period="week">7 Days</div>
                            <div class="chart-period" data-period="month">30 Days</div>
                            <div class="chart-period" data-period="year">12 Months</div>
                        </div>
                    </div>
                    <canvas id="salesChart"></canvas>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Top Selling Products</div>
                        </div>
                        <canvas id="productsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Customer Activity</div>
                        </div>
                        <canvas id="customersChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Orders Content -->
            <div class="content-section" id="orders" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">
                        <i class="fas fa-shopping-bag"></i>
                        Order Management
                    </h1>
                    <div class="content-actions">
                        <button class="btn btn-primary" id="createOrderBtn">
                            <i class="fas fa-plus"></i>
                            <span>Create Order</span>
                        </button>
                        <button class="btn btn-outline">
                            <i class="fas fa-download"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <span class="filter-label">Status:</span>
                        <select class="filter-select" id="orderStatusFilter">
                            <option value="all">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Date:</span>
                        <select class="filter-select" id="orderDateFilter">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Search:</span>
                        <input type="text" class="filter-input" id="orderSearch" placeholder="Search orders...">
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Orders will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Content -->
            <div class="content-section" id="products" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">
                        <i class="fas fa-box-open"></i>
                        Product Management
                    </h1>
                    <div class="content-actions">
                        <button class="btn btn-primary" id="addProductBtn">
                            <i class="fas fa-plus"></i>
                            <span>Add Product</span>
                        </button>
                        <button class="btn btn-outline">
                            <i class="fas fa-download"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <span class="filter-label">Category:</span>
                        <select class="filter-select" id="productCategoryFilter">
                            <option value="all">All Categories</option>
                            <option value="electronics">Electronics</option>
                            <option value="fashion">Fashion</option>
                            <option value="home">Home & Garden</option>
                            <option value="beauty">Beauty</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Status:</span>
                        <select class="filter-select" id="productStatusFilter">
                            <option value="all">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="low">Low Stock</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Search:</span>
                        <input type="text" class="filter-input" id="productSearch" placeholder="Search products...">
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Products will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Content -->
            <div class="content-section" id="analytics" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">
                        <i class="fas fa-chart-line"></i>
                        Analytics Dashboard
                    </h1>
                    <div class="content-actions">
                        <button class="btn btn-outline">
                            <i class="fas fa-download"></i>
                            <span>Export Report</span>
                        </button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <span class="filter-label">Period:</span>
                        <select class="filter-select" id="analyticsPeriodFilter">
                            <option value="week">Last 7 Days</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="summary-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">$0</div>
                        <div class="summary-label">Total Revenue</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="summary-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">0</div>
                        <div class="summary-label">Total Orders</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="summary-trend trend-neutral">
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">0</div>
                        <div class="summary-label">New Customers</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <div class="summary-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="summary-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        <div class="summary-value">0</div>
                        <div class="summary-label">Store Visits</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Revenue by Category</div>
                    </div>
                    <canvas id="revenueByCategoryChart"></canvas>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Customer Acquisition</div>
                        </div>
                        <canvas id="customerAcquisitionChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Product Performance</div>
                        </div>
                        <canvas id="productPerformanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Accounts Content -->
            <div class="content-section" id="accounts" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">
                        <i class="fas fa-wallet"></i>
                        Accounts & Finances
                    </h1>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="balance">Balance</div>
                    <div class="tab" data-tab="transactions">Transactions</div>
                    <div class="tab" data-tab="subscription">Subscription</div>
                    <div class="tab" data-tab="payouts">Payouts</div>
                </div>

                <!-- Balance Tab -->
                <div class="tab-content active" id="balanceTab">
                    <div class="balance-card">
                        <div class="balance-label">Available Balance</div>
                        <div class="balance-amount">$0.00</div>
                        <div class="balance-actions">
                            <button class="btn btn-primary" id="requestPayoutBtn">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Nil</span>
                            </button>
                            <button class="btn btn-outline" id="viewTransactionsBtn">
                                <i class="fas fa-history"></i>
                                <span>Transaction History</span>
                            </button>
                        </div>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-card-header">
                                <div class="summary-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="summary-value" id="pending-payouts-amount">$0.00</div>
                            <div class="summary-label">Pending Payments</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-header">
                                <div class="summary-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <div class="summary-value" id="processing-payouts-amount">$0.00</div>
                            <div class="summary-label">Processing Payouts</div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Tab -->
                <div class="tab-content" id="transactionsTab">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <span class="filter-label">Type:</span>
                            <select class="filter-select" id="transactionTypeFilter">
                                <option value="all">All Transactions</option>
                                <option value="sale">Sales</option>
                                <option value="payout">Payouts</option>
                                <option value="refund">Refunds</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Status:</span>
                            <select class="filter-select" id="transactionStatusFilter">
                                <option value="all">All Statuses</option>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Date:</span>
                            <select class="filter-select" id="transactionDateFilter">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table" id="transactionsTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-exchange-alt"></i></th>
                                    <th>ID</th>
                                    <th>Transaction Code</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Initial Balance</th>
                                    <th>Final Balance</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Transactions will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Content -->
            <div class="content-section" id="settings" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">
                        <i class="fas fa-cog"></i>
                        Store Settings
                    </h1>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="general">General</div>
                    <div class="tab" data-tab="appearance">Appearance</div>
                    <div class="tab" data-tab="payments">Payments</div>
                    <div class="tab" data-tab="shipping">Shipping</div>
                </div>

                <!-- General Settings Tab -->
                <div class="tab-content active" id="generalTab">
                    <div class="form-container">
                        <h3 style="margin-bottom: 1.5rem;">Store Information</h3>
                        <div class="form-group">
                            <label for="storeName" class="form-label-required">Store Name</label>
                            <input type="text" id="storeName" class="form-control" placeholder="Enter store name" value="Haklim Fashions">
                        </div>
                        <div class="form-group">
                            <label for="storeEmail" class="form-label-required">Store Email</label>
                            <input type="email" id="storeEmail" class="form-control" placeholder="Enter store email" value="haklimfashions@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="storePhone">Store Phone</label>
                            <input type="tel" id="storePhone" class="form-control" placeholder="Enter store phone" value="+254700123456">
                        </div>
                        <div class="form-group">
                            <label for="storeAddress">Store Address</label>
                            <textarea id="storeAddress" class="form-control form-textarea" placeholder="Enter store address"></textarea>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="saveGeneralSettings">
                                <i class="fas fa-save"></i>
                                <span>Save Changes</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-container" style="margin-top: 1.5rem">
    <h3 style="margin-bottom: 1.5rem">Social Media Profiles</h3>
    
    <!-- Facebook -->
    <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="facebookToggle">
            <span class="toggle-slider"></span>
            <span>Facebook</span>
        </label>
        <div id="facebookInputContainer" style="margin-top: 0.5rem">
            <input type="url" id="facebookUrl" class="form-control" 
                   placeholder="https://facebook.com/yourpage" 
                   value="">
        </div>
    </div>
    
    <!-- Instagram -->
    <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="instagramToggle">
            <span class="toggle-slider"></span>
            <span>Instagram</span>
        </label>
        <div id="instagramInputContainer" style="margin-top: 0.5rem; ">
            <input type="url" id="instagramUrl" class="form-control" 
                   placeholder="https://instagram.com/yourpage" 
                   value="">
        </div>
    </div>
    
    <!-- Twitter (X) -->
    <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="twitterToggle">
            <span class="toggle-slider"></span>
            <span>Twitter (X)</span>
        </label>
        <div id="twitterInputContainer" style="margin-top: 0.5rem; ">
            <input type="url" id="twitterUrl" class="form-control" placeholder="https://twitter.com/yourhandle" >
        </div>
    </div>
    
    <!-- LinkedIn -->
    <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="linkedinToggle">
            <span class="toggle-slider"></span>
            <span>LinkedIn</span>
        </label>
        <div id="linkedinInputContainer" style="margin-top: 0.5rem; ">
            <input type="url" id="linkedinUrl" class="form-control"   placeholder="https://linkedin.com/company/yourpage" >
        </div>
    </div>
    
    <!-- WhatsApp Business -->
    <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="whatsappToggle">
            <span class="toggle-slider"></span>
            <span>WhatsApp Business</span>
        </label>
        <div id="whatsappInputContainer" style="margin-top: 0.5rem; ">
            <input type="url" id="whatsappUrl" class="form-control" placeholder="https://wa.me/yournumber" >
        </div>
    </div>
    
    <!-- TikTok -->
    <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="tiktokToggle">
            <span class="toggle-slider"></span>
            <span>TikTok</span>
        </label>
        <div id="tiktokInputContainer" style="margin-top: 0.5rem">
            <input type="url" id="tiktokUrl" class="form-control" placeholder="https://tiktok.com/@yourhandle" >
        </div>
    </div>
    

    
    <div class="form-group">
        <button class="btn btn-primary" id="saveSocialSettings">
            <i class="fas fa-save"></i>
            <span>Save Settings</span>
        </button>
    </div>
</div>
                </div>

                <!-- Appearance Settings Tab -->
                <div class="tab-content" id="appearanceTab">
                    <div class="form-container">
                        <h3 style="margin-bottom: 1.5rem;">Store Logo</h3>
                        <div class="form-group">
                            <div class="media-upload" id="logoUploadArea">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem; color: var(--taupe);"></i>
                                <p>Drag & drop logo here or click to browse</p>
                                <input type="file" id="storeLogo" accept="image/*" style="display: none;">
                            </div>
                            <div class="media-preview-container" id="logoPreviewContainer">
                                <!-- Logo preview will be shown here -->
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="saveLogo">
                                <i class="fas fa-save"></i>
                                <span>Save Logo</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-container" style="margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1.5rem;">Color Theme</h3>
                        <div class="form-group">
                            <label>Primary Color</label>
                            <div class="color-picker">
                                <div class="color-option selected" style="background-color: #2563eb;" data-color="#2563eb"></div>
                                <div class="color-option" style="background-color: #7c3aed;" data-color="#7c3aed"></div>
                                <div class="color-option" style="background-color: #db2777;" data-color="#db2777"></div>
                                <div class="color-option" style="background-color: #059669;" data-color="#059669"></div>
                                <div class="color-option" style="background-color: #d97706;" data-color="#d97706"></div>
                                <div class="color-option" style="background-color: #dc2626;" data-color="#dc2626"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Theme Preview</label>
                            <div class="theme-preview">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-sidebar"></div>
                                <div class="theme-preview-content">
                                    <div class="theme-preview-card"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="saveThemeSettings">
                                <i class="fas fa-save"></i>
                                <span>Save Theme</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-container" style="margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1.5rem;">Font Settings</h3>
                        <div class="form-group">
                            <label for="primaryFont">Primary Font</label>
                            <select id="primaryFont" class="form-select">
                                <option value="'Plus Jakarta Sans', sans-serif">Plus Jakarta Sans</option>
                                <option value="'Inter', sans-serif">Inter</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Poppins', sans-serif">Poppins</option>
                                <option value="'Open Sans', sans-serif">Open Sans</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fontSize">Base Font Size</label>
                            <select id="fontSize" class="form-select">
                                <option value="14px">Small (14px)</option>
                                <option value="16px" selected>Medium (16px)</option>
                                <option value="18px">Large (18px)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="saveFontSettings">
                                <i class="fas fa-save"></i>
                                <span>Save Font Settings</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Payments Settings Tab -->
                <div class="tab-content" id="paymentsTab">
                    <div class="form-container">
                        <h3 style="margin-bottom: 1.5rem;">Payment Gateway</h3>
                        <div class="form-group">
                            <label class="toggle-switch">
                                <input type="checkbox" id="usePlatformPayments" checked>
                                <span class="toggle-slider"></span>
                                <span style="margin-left: 0.5rem;">Use Platform Payment System</span>
                            </label>
                        </div>
                        <div id="customPaymentSettings" style="display: none; margin-top: 1.5rem;">
                            <div class="form-group">
                                <label for="paymentGateway">Payment Gateway</label>
                                <select id="paymentGateway" class="form-select">
                                    <option value="">Select payment gateway</option>
                                    <option value="pesapal">Pesapal</option>
                                    <option value="mpesa">M-Pesa</option>
                                    <option value="stripe">Stripe</option>
                                    <option value="paypal">PayPal</option>
                                </select>
                            </div>
                            <div id="pesapalCredentials" style="display: none;">
                                <div class="form-group">
                                    <label for="pesapalConsumerKey">Consumer Key</label>
                                    <div class="password-input">
                                        <input type="password" id="pesapalConsumerKey" class="form-control" placeholder="Enter Pesapal consumer key">
                                        <button class="password-toggle" type="button">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="pesapalConsumerSecret">Consumer Secret</label>
                                    <div class="password-input">
                                        <input type="password" id="pesapalConsumerSecret" class="form-control" placeholder="Enter Pesapal consumer secret">
                                        <button class="password-toggle" type="button">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="savePaymentSettings">
                                    <i class="fas fa-save"></i>
                                    <span>Save Payment Settings</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-container" style="margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1.5rem;">Payout Settings</h3>
                        <div class="form-group">
                            <label for="payoutCurrency">Payout Currency</label>
                            <select id="payoutCurrency" class="form-select">
                                <option value="KES">Kenyan Shilling (KES)</option>
                                <option value="USD">US Dollar (USD)</option>
                                <option value="EUR">Euro (EUR)</option>
                                <option value="GBP">British Pound (GBP)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payoutSchedule">Payout Schedule</label>
                            <select id="payoutSchedule" class="form-select">
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payoutThreshold">Payout Threshold</label>
                            <input type="number" id="payoutThreshold" class="form-control" placeholder="Minimum amount for automatic payout" min="0" step="0.01" value="1000">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="savePayoutSettings">
                                <i class="fas fa-save"></i>
                                <span>Save Payout Settings</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Shipping Settings Tab -->
                <div class="tab-content" id="shippingTab">
                    <div class="form-container">
                        <h3 style="margin-bottom: 1.5rem;">Shipping Options</h3>
                        <div class="form-group">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enableShipping" checked>
                                <span class="toggle-slider"></span>
                                <span style="margin-left: 0.5rem;">Enable Shipping</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enableFreeShipping" checked>
                                <span class="toggle-slider"></span>
                                <span style="margin-left: 0.5rem;">Enable Free Shipping Threshold</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="freeShippingThreshold">Free Shipping Threshold (KES)</label>
                            <input type="number" id="freeShippingThreshold" class="form-control" placeholder="Minimum order amount for free shipping" min="0" step="1" value="5000">
                        </div>
                        <div class="form-group">
                            <label for="defaultShippingFee">Default Shipping Fee (KES)</label>
                            <input type="number" id="defaultShippingFee" class="form-control" placeholder="Default shipping fee" min="0" step="1" value="300">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="saveShippingSettings">
                                <i class="fas fa-save"></i>
                                <span>Save Shipping Settings</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-container" style="margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1.5rem;">Shipping Zones</h3>
                        <div class="form-group">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="shippingZoneName">Zone Name</label>
                                    <input type="text" id="shippingZoneName" class="form-control" placeholder="e.g. Nairobi">
                                </div>
                                <div class="form-group">
                                    <label for="shippingZoneFee">Shipping Fee (KES)</label>
                                    <input type="number" id="shippingZoneFee" class="form-control" placeholder="Shipping fee" min="0" step="1" value="150">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="shippingZoneRegions">Regions</label>
                                <select id="shippingZoneRegions" class="form-select" multiple>
                                    <option value="nairobi">Nairobi</option>
                                    <option value="mombasa">Mombasa</option>
                                    <option value="kisumu">Kisumu</option>
                                    <option value="nakuru">Nakuru</option>
                                    <option value="eldoret">Eldoret</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" id="addShippingZone">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Shipping Zone</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-container" style="margin-top: 1.5rem;">
                            <table class="data-table" id="shippingZonesTable">
                                <thead>
                                    <tr>
                                        <th>Zone Name</th>
                                        <th>Regions</th>
                                        <th>Shipping Fee</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Nairobi</td>
                                        <td>Nairobi County</td>
                                        <td>KES 150</td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="action-btn edit">
                                                    <i class="fas fa-edit"></i>
                                                    <span class="tooltip">Edit</span>
                                                </button>
                                                <button class="action-btn delete">
                                                    <i class="fas fa-trash"></i>
                                                    <span class="tooltip">Delete</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Other Counties</td>
                                        <td>All other counties</td>
                                        <td>KES 300</td>
                                        <td>
                                            <div class="table-actions">
                                                <button class="action-btn edit">
                                                    <i class="fas fa-edit"></i>
                                                    <span class="tooltip">Edit</span>
                                                </button>
                                                <button class="action-btn delete">
                                                    <i class="fas fa-trash"></i>
                                                    <span class="tooltip">Delete</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Product</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addProductCategory">Category</label>
                            <select id="addProductCategory" required>
                                <option value="Electronics & Media" selected>Electronics & Media</option>
                        <option value="Fashion & Apparel">Fashion & Apparel</option>
                        <option value="Home & Living">Home & Living</option>
                        <option value="Kitchen & Dining">Kitchen & Dining</option>
                        <option value="Beauty & Personal Care">Beauty & Personal Care</option>
                        <option value="Health & Wellness">Health & Wellness</option>
                        <option value="Sports & Outdoor">Sports & Outdoor</option>
                        <option value="Toys, Kids & Bab">Toys, Kids & Baby</option>
                        <option value="Books, Stationery & Learning">Books, Stationery & Learning</option>
                        <option value="Groceries & Food">Groceries & Food</option>
                        <option value="Automotive & Tools">Automotive & Tools</option>
                        <option value="Pets & Gardening">Pets & Gardening</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="addProductSubcategory">Subcategory</label>
                            <select id="addProductSubcategory" required disabled>
                                <option value="">Select Subcategory</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="addProductClass">Class</label>
                        <select id="addProductClass" required disabled>
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addProductBrand">Brand</label>
                            <select id="addProductBrand" required disabled>
                                <option value="">Select Brand</option>
                            </select>
                            <input type="text" id="addOtherBrandInput" placeholder="Enter brand name" style="margin-top: 0.5rem; display: none;">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="addProductName">Product Name</label>
                                <input type="text" id="addProductName" required>
                            </div>
                            <div class="form-group">
                                <label for="addProductPrice">Price (KES)</label>
                                <input type="number" id="addProductPrice" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="addProductDiscount">Discount (%)</label>
                                <input type="number" id="addProductDiscount" min="0" max="100" value="0">
                            </div>
                            <div class="form-group">
                                <label for="addProductStock">Stock Quantity</label>
                                <input type="number" id="addProductStock" min="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addProductStatus">Status</label>
                            <select id="addProductStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="addProductBadge">Badge</label>
                            <select id="addProductBadge">
                                <option value="">None</option>
                                <option value="new">New Arrival</option>
                                <option value="sale">Sale</option>
                                <option value="bestseller">Best Seller</option>
                                <option value="limited">Limited Edition</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Features</label>
                            <div class="features-list" id="addFeaturesList">
                                <!-- Features will be added here -->
                            </div>
                            <input type="hidden" id="addProductFeatures">
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="text" id="addFeatureInput" placeholder="Enter feature">
                                <button type="button" class="btn btn-secondary" id="addFeatureBtn">Add</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addProductDescription">Description</label>
                            <textarea id="addProductDescription" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Product Images (Max 7)</label>
                            <div class="media-upload" id="addImageUploadArea">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem; color: var(--taupe);"></i>
                                <p>Drag & drop images here or click to browse</p>
                                <input type="file" id="addProductImages" multiple accept="image/*" style="display: none;">
                            </div>
                            <div class="media-preview-container" id="addImagesPreviewContainer">
                                <!-- Image previews will be shown here -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Product Video (Optional)</label>
                            <div class="media-upload" id="addVideoUploadArea">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem; color: var(--taupe);"></i>
                                <p>Drag & drop video here or click to browse</p>
                                <input type="file" id="addProductVideo" accept="video/*" style="display: none;">
                            </div>
                            <div class="media-preview-container" id="addVideoPreviewContainer">
                                <!-- Video preview will be shown here -->
                            </div>
                        </div>
                        <div class="variants-section">
                            <h4>Product Variants</h4>
                            <div class="form-group">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="addHasVariantsToggle">
                                    <span class="toggle-slider"></span>
                                    <span>This product has variants</span>
                                </label>
                            </div>
                            <div id="addVariantsContainer" style="display: none;">
                                <div class="color-variants" id="addColorVariantsContainer">
                                    <!-- Color variants will be added here -->
                                </div>
                                <div class="form-group">
                                    <label>Add Color Variant</label>
                                    <input type="hidden" id="addProductVariants">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="addColorNameInput" placeholder="Color name (e.g. Red)">
                                        <button type="button" class="btn btn-secondary" id="addColorBtn">Add Color</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button class="btn btn-primary" id="saveNewProductBtn">Save Product</button>
                </div>
            </div>
        </div>

        <!-- Edit Product Modal -->
        <div class="modal" id="editProductModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Product</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editProductCategory">Category</label>
                            <select id="editProductCategory" required>
                                <option value="Electronics & Media" selected>Electronics & Media</option>
                        <option value="Fashion & Apparel">Fashion & Apparel</option>
                        <option value="Home & Living">Home & Living</option>
                        <option value="Kitchen & Dining">Kitchen & Dining</option>
                        <option value="Beauty & Personal Care">Beauty & Personal Care</option>
                        <option value="Health & Wellness">Health & Wellness</option>
                        <option value="Sports & Outdoor">Sports & Outdoor</option>
                        <option value="Toys, Kids & Bab">Toys, Kids & Baby</option>
                        <option value="Books, Stationery & Learning">Books, Stationery & Learning</option>
                        <option value="Groceries & Food">Groceries & Food</option>
                        <option value="Automotive & Tools">Automotive & Tools</option>
                        <option value="Pets & Gardening">Pets & Gardening</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editProductSubcategory">Subcategory</label>
                            <select id="editProductSubcategory" required>
                                <option value="">Select Subcategory</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editProductClass">Class</label>
                        <select id="editProductClass" required>
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editProductBrand">Brand</label>
                            <select id="editProductBrand" required>
                                <option value="">Select Brand</option>
                            </select>
                            <input type="text" id="editOtherBrandInput" placeholder="Enter brand name" style="margin-top: 0.5rem; display: none;">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProductName">Product Name</label>
                                <input type="text" id="editProductName" required>
                            </div>
                            <div class="form-group">
                                <label for="editProductPrice">Price (KES)</label>
                                <input type="number" id="editProductPrice" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="addProductDiscount">Discount (%)</label>
                                <input type="number" id="editProductDiscount" min="0" max="100" value="0">
                            </div>
                            <div class="form-group">
                                <label for="addProductStock">Stock Quantity</label>
                                <input type="number" id="editProductStock" min="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editProductStatus">Status</label>
                            <select id="editProductStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editProductBadge">Badge</label>
                            <select id="editProductBadge">
                                <option value="">None</option>
                                <option value="new">New Arrival</option>
                                <option value="sale">Sale</option>
                                <option value="bestseller">Best Seller</option>
                                <option value="limited">Limited Edition</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Features</label>
                            <div class="features-list" id="addFeaturesEditList">
                                <!-- Features will be added here -->
                            </div>
                            <input type="hidden" id="editProductFeatures">
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="text" id="editFeatureInput" placeholder="Enter feature">
                                <button type="button" class="btn btn-secondary" id="editFeatureBtn">Add</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editProductDescription">Description</label>
                            <textarea id="editProductDescription" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Product Images (Max <span id="maximum-images-count">7</span> )</label>
                            <div class="media-upload" id="editImageUploadArea">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem; color: var(--taupe);"></i>
                                <p>Drag & drop images here or click to browse</p>
                                <input type="file" id="editProductImages" multiple accept="image/*" style="display: none;">
                            </div>
                            <div class="media-preview-container" id="editImagesPreviewContainer">
                                <!-- Image previews will be shown here -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Product Video (Optional)</label>
                            <div class="media-upload" id="addVideoEditUploadArea">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 1rem; color: var(--taupe);"></i>
                                <p>Drag & drop video here or click to browse</p>
                                <input type="file" id="editProductVideo" accept="video/*" style="display: none;">
                            </div>
                            <div class="media-preview-container" id="editVideoPreviewContainer">
                                <!-- Video preview will be shown here -->
                            </div>
                        </div>
                        <div class="variants-section">
                            <h4>Product Variants</h4>
                            <div class="form-group">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="editHasVariantsToggle">
                                    <span class="toggle-slider"></span>
                                    <span>This product has variants
                                </label>
                            </div>
                            <div id="editVariantsContainer" style="display: none;">
                                <div class="color-variants" id="editColorVariantsContainer">
                                    <!-- Color variants will be added here -->
                                </div>
                                <div class="form-group">
                                    <label>Add Color Variant</label>
                                    <input type="hidden" id="editProductVariants">
                                    <input type="hidden" id="deletedMedia">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="editColorNameInput" placeholder="Color name (e.g. Red)">
                                        <button type="button" class="btn btn-secondary" id="addColorEditBtn">Add Color</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button class="btn btn-primary" id="updateProductBtn">Update Product</button>
                </div>
            </div>
        </div>

        <!-- View Product Modal -->
        <div class="modal" id="viewProductModal">
            <div class="modal-content modal-lg">
                <div class="modal-header">
                    <h3>Product Details</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div style="flex: 1;">
                            <div class="media-preview-container" id="viewProductImages">
                                <!-- Product images will be shown here -->
                            </div>
                            <div class="media-preview-container" id="viewProductVideo" style="margin-top: 1rem;">
                                <!-- Product video will be shown here if available -->
                            </div>
                        </div>
                        <div style="flex: 1; padding-left: 1.5rem;">
                            <h3 id="viewProductName"></h3>
                            <div style="display: flex; align-items: center; margin: 0.5rem 0;">
                                <span id="viewProductPrice" style="font-size: 1.5rem; font-weight: 600;"></span>
                                <span id="viewProductDiscountedPrice" style="font-size: 1.25rem; text-decoration: line-through; color: var(--text-light); margin-left: 0.5rem;"></span>
                                <span id="viewProductDiscount" style="background: var(--danger-light); color: var(--danger); padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.875rem;"></span>
                            </div>
                            <div style="margin: 0.5rem 0;">
                                <span class="status active" id="viewProductStatus"></span>
                                <span id="viewProductBadge" style="background: var(--highlight-light); color: var(--highlight); padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem; font-size: 0.875rem;"></span>
                            </div>
                            <div style="margin: 1rem 0;">
                                <div style="display: flex; gap: 1rem;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-light);">Category</div>
                                        <div id="viewProductCategory"></div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-light);">Brand</div>
                                        <div id="viewProductBrand"></div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.875rem; color: var(--text-light);">Stock</div>
                                        <div id="viewProductStock"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="viewProductVariants" style="margin: 1rem 0;">
                                <!-- Variants will be shown here if available -->
                            </div>
                            <div style="margin: 1rem 0;">
                                <h4>Features</h4>
                                <ul id="viewProductFeatures" style="padding-left: 1.25rem; margin-top: 0.5rem;">
                                    <!-- Features will be listed here -->
                                </ul>
                            </div>
                            <div style="margin: 1rem 0;">
                                <h4>Description</h4>
                                <div id="viewProductDescription" style="margin-top: 0.5rem;"></div>
                            </div>
                            <div style="margin: 1rem 0;">
                                <h4>Link</h4>
                                <a href="#" id="viewProductLink" style="margin-top: 0.5rem;">Product LInk</a>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary modal-close">Close</button>
                </div>
            </div>
        </div>

        <!-- Order Details Modal -->
        <div class="modal" id="orderDetailsModal">
            <div class="modal-content modal-lg">
                <div class="modal-header">
                    <h3>Order #<span id="orderId"></span></h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="order-details">
                        <div class="detail-row">
                            <div class="detail-label">Order Date:</div>
                            <div class="detail-value" id="orderDate"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Order Status:</div>
                            <div class="detail-value" id="orderStatus"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Payment Status:</div>
                            <div class="detail-value" id="paymentStatus"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Payment Method:</div>
                            <div class="detail-value" id="paymentMethod"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Transaction Code:</div>
                            <div class="detail-value" id="transactionCode"></div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1.5rem; margin-top: 1.5rem;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 1rem;">Customer Information</h4>
                            <div class="order-details">
                                <div class="detail-row">
                                    <div class="detail-label">Name:</div>
                                    <div class="detail-value" id="customerName"></div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Email:</div>
                                    <div class="detail-value" id="customerEmail"></div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Phone:</div>
                                    <div class="detail-value" id="customerPhone"></div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Delivery Method:</div>
                                    <div class="detail-value" id="deliveryMethod"></div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Delivery Address:</div>
                                    <div class="detail-value" id="deliveryAddress"></div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Packaging Instructions:</div>
                                    <div class="detail-value" id="packagingInstructions"></div>
                                </div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 1rem;">Order Summary</h4>
                            <table class="order-items">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Qty</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="orderItems">
                                    <!-- Order items will be populated here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3">Subtotal</td>
                                        <td id="orderSubtotal"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="3">Delivery Fee</td>
                                        <td id="orderDeliveryFee"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="3">Total</td>
                                        <td id="orderTotal"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div style="display: flex; justify-content: space-between; width: 100%;">
                        <div>
                            <button class="btn btn-danger" id="cancelOrderBtn" style="display: none;">
                                <i class="fas fa-times"></i>
                                <span>Cancel Order</span>
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary modal-close">Close</button>
                            <button class="btn btn-primary" id="updateOrderStatusBtn">
                                <i class="fas fa-sync-alt"></i>
                                <span>Update Status</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Order Status Modal -->
        <div class="modal" id="updateStatusModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Update Order Status</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="updateStatusId">Order ID:</label>
                        <p id="updateStatusId">ZXCSBDKDKJSYS</p>
                    </div>
                    <div class="form-group">
                        <label for="updateStatusCustomer">Customer:</label>
                        <p id="updateStatusCustomer"> John Doe</p>
                    </div>
                    <div class="form-group">
                        <label for="updateStatusCurrent">Current Status</label>
                        <span class="status pending" id="updateStatusCurrent">Pending</span>
                    </div>
                    <div class="form-group">
                        <input type="hidden" id="orderUpdateId">
                        <label for="newOrderStatus">New Status</label>
                        <select id="newOrderStatus" class="form-select">
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statusNotes">Notes (Optional)</label>
                        <textarea id="statusNotes" class="form-control form-textarea" rows="3" placeholder="Add any notes about this status change"></textarea>
                    </div>
                    <div class="form-group">
                        <p id="updateStatusInfo">We will notify <span id="update-status-customer">CustmerName</span> that you are now <span id="upddate-status-new">New status</span> their order. This action is not reversible once done. Please ensure the new status you set is the actual one before updating</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button class="btn btn-primary" id="confirmStatusUpdate">
                        <i class="fas fa-sync-alt"></i><span>Update</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Withdrawal Request Modal -->
<div class="modal" id="withdrawalModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Request Withdrawal</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="withdrawalAmount">Amount (KES)</label>
                <input type="number" id="withdrawalAmount" class="form-control" placeholder="Enter amount" min="500" step="1">
                <p id="withdrawalError" style="color: var(--danger); font-size: 0.875rem; margin-top: 0.5rem; display: none;"></p>
            </div>
            <div class="form-group">
                <label>Available Balance: <span id="availableBalance" style="font-weight: 600;">KES 0.00</span></label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary modal-close">Cancel</button>
            <button class="btn btn-primary" id="submitWithdrawalBtn">Request Withdrawal</button>
        </div>
    </div>
</div>

<!-- Subscription Payment Modal -->
<div class="modal" id="subscriptionModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Subscription</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="subscription-options">
                <div class="form-check">
                    <input type="radio" id="extendOption" name="subscriptionType" value="extend" checked class="form-check-input">
                    <label for="extendOption" class="form-check-label">Extend Current Plan</label>
                </div>
                <div class="form-check">
                    <input type="radio" id="upgradeOption" name="subscriptionType" value="upgrade" class="form-check-input">
                    <label for="upgradeOption" class="form-check-label">Upgrade Plan</label>
                </div>
            </div>

            <div class="current-plan-info" style="background: var(--primary-light); padding: 1rem; border-radius: var(--border-radius); margin: 1rem 0;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Current Plan:</span>
                    <strong id="currentPlanName">Starter</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Expires On:</span>
                    <strong id="currentPlanExpiry">-</strong>
                </div>
            </div>

            <div id="upgradeOptions" style="display: none;">
                <div class="form-group">
                    <label for="subscriptionPlan">Upgrade To:</label>
                    <select id="subscriptionPlanChoice" class="form-select">
                        <option value="plus">Plus - KSh 2,499/month</option>
                        <option value="pro">Pro - KSh 4,999/month</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="subscriptionPeriod">Billing Period</label>
                <select id="subscriptionPeriod" class="form-select">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly (10% discount)</option>
                    <option value="yearly">Yearly (20% discount)</option>
                </select>
            </div>

            <div id="upgradeSavings" style="background: var(--success-light); padding: 0.75rem; border-radius: var(--border-radius); margin-bottom: 1rem; display: none;">
                <div style="color: var(--success); font-weight: 500;">
                    <i class="fas fa-tag"></i> 
                    <span id="savingsText">Upgrade today and save KSh 0!</span>
                </div>
                <div style="font-size: 0.875rem; margin-top: 0.25rem;">
                    <span id="originalPrice" style="text-decoration: line-through; color: var(--text-light);"></span>
                    <span id="discountedPrice" style="font-weight: 600; margin-left: 0.5rem;"></span>
                </div>
            </div>

            <div class="payment-summary" style="background: var(--content-bg); padding: 1rem; border-radius: var(--border-radius);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Amount Due:</span>
                    <strong id="paymentAmount">KSh 0.00</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>New Expiry Date:</span>
                    <strong id="newExpiryDate">-</strong>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary modal-close">Cancel</button>
            <button class="btn btn-primary" id="submitSubscriptionBtn">Proceed to Payment</button>
        </div>
    </div>
</div>

<!-- Payment Iframe Modal -->
<div class="modal" id="paymentIframeModal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>Complete Payment</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0; height: 600px;">
            <iframe id="paymentFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
</div>

        <!-- Subscription Payment Modal -->
        <div class="modal" id="subscriptionPaymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Upgrade Subscription</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Selected Plan</label>
                        <div style="background: var(--content-bg); padding: 1rem; border-radius: var(--border-radius);">
                            <div style="display: flex; justify-content: space-between;">
                                <span id="selectedPlanName" style="font-weight: 600;"></span>
                                <span id="selectedPlanPrice" style="font-weight: 600;"></span>
                            </div>
                            <div id="selectedPlanFeatures" style="margin-top: 0.5rem;">
                                <!-- Plan features will be listed here -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethodSelect">Payment Method</label>
                        <select id="paymentMethodSelect" class="form-select">
                            <option value="mpesa">M-Pesa</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                    <div id="mpesaPaymentSection">
                        <div class="form-group">
                            <label for="mpesaPhoneNumber">M-Pesa Phone Number</label>
                            <input type="text" id="mpesaPhoneNumber" class="form-control" placeholder="e.g. 254712345678">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="initiateMpesaPayment" style="width: 100%;">
                                <i class="fas fa-mobile-alt"></i>
                                <span>Pay via M-Pesa</span>
                            </button>
                        </div>
                    </div>
                    <div id="cardPaymentSection" style="display: none;">
                        <div class="form-group">
                            <label for="cardNumber">Card Number</label>
                            <input type="text" id="cardNumber" class="form-control" placeholder="1234 5678 9012 3456">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cardExpiry">Expiry Date</label>
                                <input type="text" id="cardExpiry" class="form-control" placeholder="MM/YY">
                            </div>
                            <div class="form-group">
                                <label for="cardCvc">CVC</label>
                                <input type="text" id="cardCvc" class="form-control" placeholder="CVC">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" id="processCardPayment" style="width: 100%;">
                                <i class="fas fa-credit-card"></i>
                                <span>Pay with Card</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal" id="confirmationModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="confirmationTitle">Confirm Action</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">Are you sure you want to perform this action?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>

        <script>
            // Merchant Admin Panel - Main JavaScript
    const categoriesData = {
                "categories": [
                    {
                        "category": "Electronics & Media",
                        "subcategories": [
                            { "subcategory": "Mobile Phones & Accessories", "classes": ["Smartphone", "Phone Case", "Charger", "Cable", "Screen Protector", "Power Bank", "Headset", "Earbud", "Memory Card", "SIM Card"] },
                            { "subcategory": "TVs & Home Entertainment", "classes": ["Television", "Streaming Device", "Set-top Box", "Satellite Receiver", "TV Mount", "TV Stand", "Projector", "Projector Screen"] },
                            { "subcategory": "Audio", "classes": ["Wired Headphone", "Wireless Headphone", "Bluetooth Speaker", "Soundbar", "Home Theater System", "Turntable", "Vinyl Player", "Audio Cable", "Audio Adapter"] },
                            { "subcategory": "Computers & Peripherals", "classes": ["Laptop", "Ultrabook", "Desktop Computer", "All-in-One Computer", "Computer Monitor", "Keyboard", "Mouse", "Printer", "Scanner", "External Hard Drive", "SSD", "USB Flash Drive", "Router", "Modem"] },
                            { "subcategory": "Cameras & Photography", "classes": ["DSLR Camera", "Mirrorless Camera", "Point-and-Shoot Camera", "Action Camera", "Camera Lens", "Tripod", "Camera Mount", "Lighting Equipment", "Memory Card"] },
                            { "subcategory": "Gaming", "classes": ["Gaming Console", "Gaming PC", "Gaming Laptop", "Gaming Controller", "Joystick", "VR Headset", "Video Game", "Gaming Headset"] },
                            { "subcategory": "Musical Instruments & Audio Gear", "classes": ["Electric Guitar", "Acoustic Guitar", "Bass Guitar", "Keyboard", "Digital Piano", "Drum Kit", "Percussion Instrument", "Microphone", "Amplifier", "Effects Pedal", "DJ Equipment", "Mixer", "Music Stand", "Instrument Case"] },
                            { "subcategory": "Professional Audio & PA Systems", "classes": ["PA Speaker", "PA Amplifier", "PA Mixer", "Wired Microphone", "Wireless Microphone", "Signal Processor", "Equalizer", "Crossover", "Audio Cable", "Microphone Stand", "Stage Monitor"] },
                            { "subcategory": "Media & Software", "classes": ["Software", "DVD", "Blu-ray", "CD", "eBook", "Audiobook", "Video Streaming Subscription", "Gift Card", "Digital Code"] }
                        ]
                    },
                    // Other categories as provided in the original data
                ]
            };

            // Brands data
            const brandsData = {
                "Smartphone": ["Apple", "Samsung", "OnePlus", "Google", "Huawei", "Xiaomi", "Sony", "Motorola", "generic", "other"],
                "Phone Case": ["OtterBox", "Spigen", "Caseology", "UAG", "Ringke", "generic", "other"],
                // Other brands as provided in the original data
            };

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
    const menuItems = document.querySelectorAll('.menu-item');
    const contentSections = document.querySelectorAll('.content-section');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const modals = document.querySelectorAll('.modal');
    const modalCloseButtons = document.querySelectorAll('.modal-close');
    const addProductBtn = document.getElementById('addProductBtn');
    const addProductModal = document.getElementById('addProductModal');
    const editProductModal = document.getElementById('editProductModal');
    const viewProductModal = document.getElementById('viewProductModal');
    const orderDetailsModal = document.getElementById('orderDetailsModal');
    const updateStatusModal = document.getElementById('updateStatusModal');
    const subscriptionPaymentModal = document.getElementById('subscriptionPaymentModal');
    const confirmationModal = document.getElementById('confirmationModal');
    const productsTable = document.getElementById('productsTable').getElementsByTagName('tbody')[0];
    const ordersTable = document.getElementById('ordersTable').getElementsByTagName('tbody')[0];
    const transactionsTable = document.getElementById('transactionsTable').getElementsByTagName('tbody')[0];
    //const payoutsTable = document.getElementById('payoutsTable').getElementsByTagName('tbody')[0];
    const shippingZonesTable = document.getElementById('shippingZonesTable').getElementsByTagName('tbody')[0];
    const toastContainer = document.getElementById('toastContainer');
    const orderBadge = document.querySelector('.menu-item[data-target="orders"] .menu-badge');



    document.addEventListener('DOMContentLoaded', function() {
     // Toggle sidebar on mobile
        hamburger.addEventListener('click', function() {
            sidebar.classList.toggle('active');
        });
        
    // Global state
    const state = {
        merchant: null,
        products: [],
        orders: [],
        loading: false,
        currentOrderStatus: null,
        currentOrderUpdateId: null
    };
    // Initialize the application
    init();

    // Main initialization function
    async function init() {
        // Set up event listeners
        setupEventListeners();
        
        // Fetch initial data
        await fetchMerchantData();
        
        // Initialize UI components
        initializeUI();
    }


function formatNumber(num, decimals = 2) {
    // Handle null/undefined/empty string
    if (num === null || num === undefined || num === '') return '0.00';
    
    // Convert to number if it's a string
    const number = typeof num === 'string' ? parseFloat(num) : num;
    
    // Handle NaN cases
    if (isNaN(number)) return '0.00';
    
    // Format with commas and fixed decimals
    return number.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

    // Calculate next payout date (7th of next month)
function getNextPayoutDate() {
    const today = new Date();
    let nextMonth = today.getMonth() + 1;
    let year = today.getFullYear();
    
    if (nextMonth > 11) {
        nextMonth = 0;
        year++;
    }
    
    // If today is after the 7th, show next month's 7th
    const payoutDate = new Date(year, nextMonth, 7);
    
    // Format as "Mar 7, 2023"
    return payoutDate.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
}

    // Set up event listeners
    function setupEventListeners() {

        // Menu item click handler
        menuItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all menu items
                menuItems.forEach(i => i.classList.remove('active'));
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Hide all content sections
                contentSections.forEach(section => section.style.display = 'none');
                
                // Show the selected content section
                const target = this.getAttribute('data-target');
                document.getElementById(target).style.display = 'block';
                
                // Close sidebar on mobile after selection
                if (window.innerWidth <= 1024) {
                    sidebar.classList.remove('active');
                }
            });
        });

        // Tab click handler
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab contents
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Show the selected tab content
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId + 'Tab').classList.add('active');
            });
        });

        // Modal close handlers
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.modal').classList.remove('active');
            });
        });

        // Close modal when clicking outside
        modals.forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // Add Product button click handler
        addProductBtn.addEventListener('click', function() {
            addProductModal.classList.add('active');
        });

        // Initialize product category dropdowns
        setupProductFormDropdowns();

        // Product variants toggle
        const hasVariantsToggle = document.getElementById('addHasVariantsToggle');
        const variantsContainer = document.getElementById('addVariantsContainer');
        hasVariantsToggle.addEventListener('change', function() {
            variantsContainer.style.display = this.checked ? 'block' : 'none';
        });

        // Add color variant
        const addColorBtn = document.getElementById('addColorBtn');
        addColorBtn.addEventListener('click', addColorVariant);

        // Add product feature
        const addFeatureBtn = document.getElementById('addFeatureBtn');
        addFeatureBtn.addEventListener('click', addProductFeature);

        // Image upload
        setupImageUpload();

        // Video upload
        setupVideoUpload();

        // Save new product
        const saveNewProductBtn = document.getElementById('saveNewProductBtn');
        saveNewProductBtn.addEventListener('click', saveNewProduct);

        // Update order status
        document.getElementById('updateOrderStatusBtn').addEventListener('click', function() {
            updateStatusModal.classList.add('active');
            orderDetailsModal.classList.remove('active');
            populateNextStatusOptions();
        });

        document.getElementById('confirmStatusUpdate').addEventListener('click', updateOrderStatus);

        // Cancel order
        document.getElementById('cancelOrderBtn').addEventListener('click', function() {
            showConfirmation('Cancel Order', 'Are you sure you want to cancel this order?', function() {
                cancelCurrentOrder();
            });
        });

        // Subscription upgrade
        //document.getElementById('upgradePlanBtn').addEventListener('click', showSubscriptionPaymentModal);

        document.getElementById('viewTransactionsBtn').addEventListener('click', function() {
            document.querySelector('.tab[data-tab="transactions"]').click();
        });


        // Save settings
        document.getElementById('saveGeneralSettings').addEventListener('click', saveGeneralSettings);
        document.getElementById('saveSocialSettings').addEventListener('click', saveSocialSettings);
        document.getElementById('saveLogo').addEventListener('click', saveLogo);
        document.getElementById('saveThemeSettings').addEventListener('click', saveThemeSettings);
        document.getElementById('saveFontSettings').addEventListener('click', saveFontSettings);
        document.getElementById('savePaymentSettings').addEventListener('click', savePaymentSettings);
        document.getElementById('savePayoutSettings').addEventListener('click', savePayoutSettings);
        document.getElementById('saveShippingSettings').addEventListener('click', saveShippingSettings);

        // Toggle custom payment settings
        document.getElementById('usePlatformPayments').addEventListener('change', function() {
            document.getElementById('customPaymentSettings').style.display = this.checked ? 'none' : 'block';
        });

        // Toggle payment gateway settings
        document.getElementById('paymentGateway').addEventListener('change', function() {
            document.getElementById('pesapalCredentials').style.display = this.value === 'pesapal' ? 'block' : 'none';
        });

        // Toggle password visibility
        document.querySelectorAll('.password-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                if (input.type === 'password') {
                    input.type = 'text';
                    this.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    input.type = 'password';
                    this.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });
        });

        // Add shipping zone
        document.getElementById('addShippingZone').addEventListener('click', addShippingZone);
    }

    // Initialize UI components
    function initializeUI() {
        // Initialize charts
        initializeCharts();
        
        // Update order badge count
        updateOrderBadge();
    }

    // Fetch merchant data from server
    async function fetchMerchantData() {
        try {
            setLoading(true);
            const response = await fetch('/fetch/get-admin-data');
            
            if (!response.ok) {
                throw new Error('Failed to fetch merchant data');
            }
            
            const data = await response.json();
            // Update state
            state.merchant = data.merchant;
            state.products = data.products;
            state.orders = data.orders;
            
            // Populate tables
            populateProductsTable();
            populateOrdersTable();
            populateTransactionsTable();
            populatePayoutsTable();
            
            // Update merchant info in UI
            updateMerchantInfo();
            
        } catch (error) {
            showToast(`Error fetching data: ${error.message}`, 'error');
            console.error('Error fetching merchant data:', error);
        } finally {
            setLoading(false);
        }
    }

    // Update merchant info in UI
    function updateMerchantInfo() {
        if (!state.merchant) return;

         // Update balance in accounts section
        if (state.merchant.cash_balance) {
            document.querySelector('.balance-amount').textContent = `Kes ${formatNumber(parseFloat(state.merchant.cash_balance))}`;
        }

        if (state.orders.length > 0) {
           const totalPendingAmount = state.orders.reduce((sum, order) => sum + parseFloat(order.total), 0);
           document.getElementById('pending-payouts-amount').textContent = `Kes ${formatNumber(totalPendingAmount)}`;
        }

        if (state.merchant.withdrawal_request) {
           document.getElementById('processing-payouts-amount').textContent = `Kes ${formatNumber(state.merchant.withdrawal_request.amount)}`;
        }

        // Set the next payout date
document.getElementById('next-payout-date').textContent = getNextPayoutDate();
        
        // Update store name in settings
        document.getElementById('storeName').value = state.merchant.store_name;
        document.getElementById('storeEmail').value = state.merchant.email;
        document.getElementById('storePhone').value = state.merchant.telephone;
        
        // Update social media links if they exist
        if (state.merchant.social_handles) {
            const socials = state.merchant.social_handles;// JSON.parse(state.merchant.social_handles.replace(/'/g, '"'));
            if (socials.facebook) document.getElementById('facebookUrl').value = socials.facebook;
            if (socials.instagram) document.getElementById('instagramUrl').value = socials.instagram;
            if (socials.twitter) document.getElementById('twitterUrl').value = socials.twitter;
        }


        document.getElementById('subscriptionPlan').textContent = state.merchant.subscription_plan.plan;
        document.getElementById('subscriptionStartDate').textContent = `${state.merchant.subscription_plan.from.day}/` +
            `${state.merchant.subscription_plan.from.month}/` +
            `${state.merchant.subscription_plan.from.year}`;
        document.getElementById('subscriptionPlanExpiry').textContent = `${state.merchant.subscription_plan.expiry.day}/` +
            `${state.merchant.subscription_plan.expiry.month}/` +
            `${state.merchant.subscription_plan.expiry.year}`;

            }

    // Populate products table
    function populateProductsTable() {
        productsTable.innerHTML = '';
        
        state.products.forEach(product => {
            const row = productsTable.insertRow();
            
            // Product name cell with image
            const nameCell = row.insertCell(0);
            nameCell.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div style="width: 40px; height: 40px; border-radius: 4px; overflow: hidden;">
                        <img src="${product.images[0] || 'https://via.placeholder.com/40'}" alt="Product" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div>
                        <div style="font-weight: 500;">${product.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-light);">ID: ${product.id}</div>
                    </div>
                </div>
            `;
            
            // Category cell
            const categoryCell = row.insertCell(1);
            categoryCell.textContent = product.category;
            
            // Price cell
            const priceCell = row.insertCell(2);
            if (product.discount > 0) {
                const discountedPrice = product.discounted_price || (product.price - (product.price * (product.discount / 100)));
                priceCell.innerHTML = `
                    <div style="font-weight: 500;">KES ${formatNumber(Number(discountedPrice))}</div>
                    <div style="font-size: 0.75rem; color: var(--text-light); text-decoration: line-through;">KES ${formatNumber(Number(product.price))}</div>
                    <div style="font-size: 0.75rem; color: var(--danger);">${(100 * (product.discount / product.price)).toFixed(2)}% off</div>
                `;
            } else {
                priceCell.innerHTML = `<div style="font-weight: 500;">KES ${formatNumber(Number(product.price))}</div>`;
            }
            
            // Stock cell
            const stockCell = row.insertCell(3);
            stockCell.textContent = product.stock;
            
            // Status cell
            const statusCell = row.insertCell(4);
            const statusSpan = document.createElement('span');
            statusSpan.className = `status ${product.status}`;
            statusSpan.textContent = product.status === 'active' ? 'Active' : 'Inactive';
            statusCell.appendChild(statusSpan);
            
            // Actions cell
            const actionsCell = row.insertCell(5);
            actionsCell.innerHTML = `
                <div class="table-actions">
                    <button class="action-btn view" data-id="${product.id}">
                        <i class="fas fa-eye"></i>
                        <span class="tooltip">View</span>
                    </button>
                    <button class="action-btn edit" data-id="${product.id}">
                        <i class="fas fa-edit"></i>
                        <span class="tooltip">Edit</span>
                    </button>
                    <button class="action-btn toggle-status" data-id="${product.id}" data-status="${product.status}">
                        <i class="fas ${product.status === 'active' ? 'fa-eye-slash' : 'fa-eye'}"></i>
                        <span class="tooltip">${product.status === 'active' ? 'Deactivate' : 'Activate'}</span>
                    </button>
                    <button class="action-btn delete" data-id="${product.id}">
                        <i class="fas fa-trash"></i>
                        <span class="tooltip">Delete</span>
                    </button>
                </div>
            `;
            
            // Add event listeners to action buttons
            const viewBtn = actionsCell.querySelector('.view');
            const editBtn = actionsCell.querySelector('.edit');
            const toggleStatusBtn = actionsCell.querySelector('.toggle-status');
            const deleteBtn = actionsCell.querySelector('.delete');
            
            viewBtn.addEventListener('click', function() {
                viewProduct(product.id);
            });
            
            editBtn.addEventListener('click', function() {
                editProduct(product.id);
            });
            
            toggleStatusBtn.addEventListener('click', function() {
                toggleProductStatus(product.id, product.status === 'active' ? 'inactive' : 'active');
            });
            
            deleteBtn.addEventListener('click', function() {
                showConfirmation('Delete Product', 'Are you sure you want to delete this product?', function() {
                    deleteProduct(product.id);
                });
            });
        });
    }

    // Populate orders table
    function populateOrdersTable() {
        ordersTable.innerHTML = '';
        
        state.orders.forEach(order => {
            const row = ordersTable.insertRow();
            
            // Order ID
            const idCell = row.insertCell(0);
            idCell.innerHTML = `
                <div style="font-weight: 500;">${order.id}</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">${new Date(order.order_timestamp).toLocaleDateString()}</div>
            `;
            
            // Customer
            const customerCell = row.insertCell(1);
            customerCell.innerHTML = `
                <div style="font-weight: 500;">${order.customer_info.firstname} ${order.customer_info.lastname}</div>
                <div style="font-size: 0.75rem; color: var(--text-light);">${order.customer_info.email}</div>
            `;
            
            // Date
            const dateCell = row.insertCell(2);
            const orderDate = order.order_timestamp ? new Date(order.order_timestamp) : 
                            (order.date ? new Date(order.date.year, order.date.month - 1, order.date.day) : new Date());
            dateCell.textContent = orderDate.toLocaleDateString();
            
            // Items count
            const itemsCell = row.insertCell(3);
            itemsCell.textContent = order.items.reduce((total, item) => total + item.quantity, 0);
            
            // Total
            const totalCell = row.insertCell(4);
            totalCell.textContent = `KES ${formatNumber(Number(order.total))}`;
            
            // Status
            const statusCell = row.insertCell(5);
            const statusSpan = document.createElement('span');
            statusSpan.className = `status ${order.status}`;
            statusSpan.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
            statusCell.appendChild(statusSpan);
            
            // Actions
            const actionsCell = row.insertCell(6);
            actionsCell.innerHTML = `
                <div class="table-actions">
                    <button class="action-btn view-order" data-id="${order.id}">
                        <i class="fas fa-eye"></i>
                        <span class="tooltip">View</span>
                    </button>
                    <button class="action-btn update-status" data-id="${order.id}" data-status="${order.status}">
                        <i class="fas fa-sync-alt"></i>
                        <span class="tooltip">Update Status</span>
                    </button>
                </div>
            `;
            
            // Add event listeners
            const viewBtn = actionsCell.querySelector('.view-order');
            const updateBtn = actionsCell.querySelector('.update-status');
            
            viewBtn.addEventListener('click', function() {
                viewOrder(order.id);
            });
            
            updateBtn.addEventListener('click', function() {
                state.currentOrderStatus = order.status;
                state.currentOrderUpdateId = order.id;
                updateStatusModal.classList.add('active');
                populateNextStatusOptions();
            });
        });
        
        // Update order badge count
        updateOrderBadge();
    }

    // Populate transactions table
// Populate transactions table with COD support
function populateTransactionsTable() {
    if (!state.merchant || !state.merchant.transaction_history) return;
    
    transactionsTable.innerHTML = '';
    
    try {
        const transactions = state.merchant.transaction_history;
        
        transactions.forEach((transaction, index) => {
            const row = transactionsTable.insertRow();
            
            // Icon column
            const iconCell = row.insertCell(0);
            const icon = document.createElement('i');
            
            if (transaction.transaction === 'credit') {
                icon.className = 'fas fa-arrow-down';
                icon.style.color = 'var(--success)';
            } else if (transaction.transaction === 'cod') {
                icon.className = 'fas fa-money-bill-wave';
                icon.style.color = 'var(--info)';
            } else {
                icon.className = 'fas fa-arrow-up';
                icon.style.color = 'var(--danger)';
            }
            
            iconCell.appendChild(icon);
            
            // ID column
            const idCell = row.insertCell(1);
            idCell.textContent = `TXN-${String(index + 1).padStart(4, '0')}`;
            
            // Transaction Code column
            const codeCell = row.insertCell(2);
            codeCell.textContent = transaction.transaction_code || 'N/A';
            
            // Amount column (color-coded with + or -)
            const amountCell = row.insertCell(3);
            let amountSign = '';
            
            if (transaction.transaction === 'credit') {
                amountSign = '+';
                amountCell.className = 'amount-positive';
            } else if (transaction.transaction === 'cod') {
                amountSign = '';
                amountCell.className = 'amount-neutral';
            } else {
                amountSign = '-';
                amountCell.className = 'amount-negative';
            }
            
            amountCell.textContent = `${amountSign}${formatNumber(transaction.amount)}`;
            
            // Description column
            const descriptionCell = row.insertCell(4);
            descriptionCell.textContent = transaction.description;
            
            // Initial Balance column
            const initialCell = row.insertCell(5);
            initialCell.textContent = formatNumber(transaction.initial_balance);
            
            // Final Balance column
            const finalCell = row.insertCell(6);
            finalCell.textContent = formatNumber(transaction.final_balance);
            
            // Type column (styled pill)
            const typeCell = row.insertCell(7);
            const typePill = document.createElement('span');
            
            if (transaction.transaction === 'credit') {
                typePill.className = 'status transaction-credit';
                typePill.textContent = 'Credit';
            } else if (transaction.transaction === 'cod') {
                typePill.className = 'status transaction-cod';
                typePill.textContent = 'C on D';
            } else {
                typePill.className = 'status transaction-debit';
                typePill.textContent = 'Debit';
            }
            
            typeCell.appendChild(typePill);
            
            // Actions column
            const actionsCell = row.insertCell(8);
            actionsCell.innerHTML = `
                <div class="table-actions">
                    <button class="action-btn view">
                        <i class="fas fa-eye"></i>
                        <span class="tooltip">View</span>
                    </button>
                </div>
            `;
        });
    } catch (error) {
        console.error('Error parsing transaction history:', error);
    }
}

    // Populate payouts table
    function populatePayoutsTable() {
    }

    // Update order badge count
    function updateOrderBadge() {
        if (orderBadge) {
            orderBadge.textContent = state.orders.length;
        }
    }





    // View product details
    function viewProduct(id) {
        const product = state.products.find(p => p.id === id);
        if (!product) return;
        
        // Populate the view modal
        document.getElementById('viewProductName').textContent = product.name;
        document.getElementById('viewProductPrice').textContent = `KES ${formatNumber(Number(product.discounted_price))}`;
        
        if (product.discount > 0) {
            document.getElementById('viewProductDiscountedPrice').textContent = `KES ${formatNumber(Number(product.price))}`;
            document.getElementById('viewProductDiscount').textContent = `${product.discount}% OFF`;
        } else {
            document.getElementById('viewProductDiscountedPrice').textContent = '';
            document.getElementById('viewProductDiscount').textContent = '';
        }
        
        document.getElementById('viewProductStatus').textContent = product.status === 'active' ? 'Active' : 'Inactive';
        
        if (product.badge) {
            document.getElementById('viewProductBadge').textContent = product.badge;
        } else {
            document.getElementById('viewProductBadge').textContent = '';
        }
        
        document.getElementById('viewProductCategory').textContent = `${product.category} > ${product.subcategory}`;
        document.getElementById('viewProductBrand').textContent = product.brand;
        document.getElementById('viewProductStock').textContent = product.stock;
        const productUrl = document.getElementById('viewProductLink');
        const link = `https://shopjani.com/product/sp/${product.link_endpoint}`;
        productUrl.textContent = link;
        productUrl.href = link;

        // Populate features
        const featuresList = document.getElementById('viewProductFeatures');
        featuresList.innerHTML = '';
        product.features.forEach(feature => {
            const li = document.createElement('li');
            li.textContent = feature;
            featuresList.appendChild(li);
        });
        
        // Populate description
        document.getElementById('viewProductDescription').textContent = product.description;
        
        // Populate images
        const imagesContainer = document.getElementById('viewProductImages');
        imagesContainer.innerHTML = '';
        product.images.forEach(image => {
            const preview = document.createElement('div');
            preview.className = 'media-preview';
            preview.innerHTML = `
                <img src="${image}" alt="Product Image">
            `;
            imagesContainer.appendChild(preview);
        });
        
        // Populate video if available
        const videoContainer = document.getElementById('viewProductVideo');
        videoContainer.innerHTML = '';
        if (product.video) {
            const preview = document.createElement('div');
            preview.className = 'media-preview';
            preview.innerHTML = `
                <video controls>
                    <source src="${product.video}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            `;
            videoContainer.appendChild(preview);
        }
        
        // Show the modal
        viewProductModal.classList.add('active');
    }

    function resetEditProductForm() {
    // Clear all inputs
    document.getElementById('editProductForm').reset();
    
    // Clear preview containers
    document.getElementById('editImagesPreviewContainer').innerHTML = '';
    document.getElementById('editVideoPreviewContainer').innerHTML = '';
    
    // Reset hidden inputs
    document.getElementById('editProductFeatures').value = '[]';
    document.getElementById('editProductVariants').value = '[]';
    document.getElementById('deletedMedia').value = '[]';
    
    // Reset variants container
    document.getElementById('editHasVariantsToggle').checked = false;
    document.getElementById('editVariantsContainer').style.display = 'none';
    document.getElementById('editColorVariantsContainer').innerHTML = '';
}

function populateEditProductCategoryDropdowns(category, subcategory, productClass) {
    const categorySelect = document.getElementById('editProductCategory');
    const subcategorySelect = document.getElementById('editProductSubcategory');
    const classSelect = document.getElementById('editProductClass');
    
    // Set category
    categorySelect.value = category;
    
    // Populate subcategories based on selected category
    const selectedCategory = categoriesData.categories.find(c => c.category === category);
    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
    
    if (selectedCategory) {
        selectedCategory.subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.subcategory;
            option.textContent = sub.subcategory;
            subcategorySelect.appendChild(option);
        });
        
        subcategorySelect.value = subcategory;
        subcategorySelect.disabled = false;
        
        // Populate classes based on selected subcategory
        const selectedSubcategory = selectedCategory.subcategories.find(s => s.subcategory === subcategory);
        classSelect.innerHTML = '<option value="">Select Class</option>';
        
        if (selectedSubcategory) {
            selectedSubcategory.classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classSelect.appendChild(option);
            });
            
            classSelect.value = productClass;
            classSelect.disabled = false;
        }
    }
    
    // Add event listeners for dynamic dropdowns
    categorySelect.addEventListener('change', function() {
        const selectedCat = categoriesData.categories.find(c => c.category === this.value);
        subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
        classSelect.innerHTML = '<option value="">Select Class</option>';
        classSelect.disabled = true;
        
        if (selectedCat) {
            selectedCat.subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.subcategory;
                option.textContent = sub.subcategory;
                subcategorySelect.appendChild(option);
            });
            subcategorySelect.disabled = false;
        } else {
            subcategorySelect.disabled = true;
        }
    });
    
    subcategorySelect.addEventListener('change', function() {
        const selectedCat = categoriesData.categories.find(c => c.category === categorySelect.value);
        if (!selectedCat) return;
        
        const selectedSub = selectedCat.subcategories.find(s => s.subcategory === this.value);
        classSelect.innerHTML = '<option value="">Select Class</option>';
        
        if (selectedSub) {
            selectedSub.classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classSelect.appendChild(option);
            });
            classSelect.disabled = false;
        } else {
            classSelect.disabled = true;
        }
    });
}

function setupEditProductBrandDropdown(brand) {
    const brandSelect = document.getElementById('editProductBrand');
    const otherBrandInput = document.getElementById('editOtherBrandInput');
    const classSelect = document.getElementById('editProductClass');
    
    // Get brands for current class
    const updateBrands = () => {
        const selectedClass = classSelect.value;
        const brands = brandsData[selectedClass] || ['generic', 'other'];
        
        brandSelect.innerHTML = '';
        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            option.textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
            brandSelect.appendChild(option);
        });
        
        // Check if current brand exists in options
        if (brands.includes(brand.toLowerCase())) {
            brandSelect.value = brand.toLowerCase();
            otherBrandInput.style.display = 'none';
        } else {
            brandSelect.value = 'other';
            otherBrandInput.style.display = 'block';
            otherBrandInput.value = brand;
        }
    };
    
    // Initial setup
    updateBrands();
    
    // Handle class change
    classSelect.addEventListener('change', updateBrands);
    
    // Handle brand selection change
    brandSelect.addEventListener('change', function() {
        otherBrandInput.style.display = this.value === 'other' ? 'block' : 'none';
    });
}

function populateEditProductFeatures(features) {
    const featuresList = document.getElementById('addFeaturesEditList');
    featuresList.innerHTML = '';
    
    features.forEach(feature => {
        const featureTag = document.createElement('div');
        featureTag.className = 'feature-tag';
        featureTag.innerHTML = `
            <span>${feature}</span>
            <button class="delete-feature">
                <i class="fas fa-times"></i>
            </button>
        `;
        featuresList.appendChild(featureTag);
        
        featureTag.querySelector('.delete-feature').addEventListener('click', function() {
            featureTag.remove();
            updateEditProductFeatures();
        });
    });
    
    // Add feature button
    document.getElementById('editFeatureBtn').addEventListener('click', function() {
        const featureInput = document.getElementById('editFeatureInput');
        if (!featureInput.value.trim()) return;
        
        const featureTag = document.createElement('div');
        featureTag.className = 'feature-tag';
        featureTag.innerHTML = `
            <span>${featureInput.value.trim()}</span>
            <button class="delete-feature">
                <i class="fas fa-times"></i>
            </button>
        `;
        featuresList.appendChild(featureTag);
        featureInput.value = '';
        
        featureTag.querySelector('.delete-feature').addEventListener('click', function() {
            featureTag.remove();
            updateEditProductFeatures();
        });
        
        updateEditProductFeatures();
    });
}

function updateEditProductFeatures() {
    const features = Array.from(document.querySelectorAll('#addFeaturesEditList .feature-tag span'))
        .map(el => el.textContent);
    document.getElementById('editProductFeatures').value = JSON.stringify(features);
}

function setupEditProductVariants(variants) {
    const hasVariantsToggle = document.getElementById('editHasVariantsToggle');
    const variantsContainer = document.getElementById('editVariantsContainer');
    const colorVariantsContainer = document.getElementById('editColorVariantsContainer');
    
    // Set initial state
    hasVariantsToggle.checked = variants.length > 0;
    variantsContainer.style.display = variants.length > 0 ? 'block' : 'none';
    colorVariantsContainer.innerHTML = '';
    
    // Add existing variants
    variants.forEach(variant => {
        addEditProductColorVariant(variant);
    });
    
    // Update variants hidden input
    updateEditProductVariants();
    
    // Toggle change handler
    hasVariantsToggle.addEventListener('change', function() {
        variantsContainer.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) {
            colorVariantsContainer.innerHTML = '';
            updateEditProductVariants();
        }
    });
    
    // Add color button handler
    document.getElementById('addColorEditBtn').addEventListener('click', function() {
        const colorInput = document.getElementById('editColorNameInput');
        if (!colorInput.value.trim()) return;
        
        addEditProductColorVariant({
            color: colorInput.value.trim(),
            sizes: []
        });
        colorInput.value = '';
    });
}

function addEditProductColorVariant(variant) {
    const colorVariantsContainer = document.getElementById('editColorVariantsContainer');
    
    const variantDiv = document.createElement('div');
    variantDiv.className = 'color-variant';
    variantDiv.innerHTML = `
        <div class="color-header">
            <div class="color-name">${variant.color}</div>
            <div class="color-actions">
                <button class="action-btn delete-color">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="sizes-list">
            ${variant.sizes.map(size => `
                <div class="size-tag" data-size="${size.size}" data-stock="${size.stock}">
                    <span>${size} (${size.stock})</span>
                    <button class="delete-size">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('')}
        </div>
        <div class="add-size-container">
            <input type="text" class="size-input" placeholder="Size (e.g. XL)">
            <input type="number" class="stock-input" placeholder="Qty" min="0">
            <button type="button" class="btn btn-secondary add-size-btn">Add Size</button>
        </div>
    `;
    
    colorVariantsContainer.appendChild(variantDiv);
    
    // Add event listeners
    variantDiv.querySelector('.delete-color').addEventListener('click', function() {
        variantDiv.remove();
        updateEditProductVariants();
    });
    
    variantDiv.querySelectorAll('.delete-size').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.size-tag').remove();
            updateEditProductVariants();
        });
    });
    
    variantDiv.querySelector('.add-size-btn').addEventListener('click', function() {
        const sizeInput = variantDiv.querySelector('.size-input');
        const stockInput = variantDiv.querySelector('.stock-input');
        
        if (!sizeInput.value || !stockInput.value) {
            showToast('Please enter both size and quantity', 'error');
            return;
        }
        
        const sizeTag = document.createElement('div');
        sizeTag.className = 'size-tag';
        sizeTag.dataset.size = sizeInput.value;
        sizeTag.dataset.stock = stockInput.value;
        sizeTag.innerHTML = `
            <span>${sizeInput.value} (${stockInput.value})</span>
            <button class="delete-size">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        variantDiv.querySelector('.sizes-list').appendChild(sizeTag);
        sizeInput.value = '';
        stockInput.value = '';
        
        sizeTag.querySelector('.delete-size').addEventListener('click', function() {
            sizeTag.remove();
            updateEditProductVariants();
        });
        
        updateEditProductVariants();
    });
}

function updateEditProductVariants() {
    const variants = [];
    
    document.querySelectorAll('#editColorVariantsContainer .color-variant').forEach(variantDiv => {
        const color = variantDiv.querySelector('.color-name').textContent;
        const sizes = [];
        
        variantDiv.querySelectorAll('.sizes-list .size-tag').forEach(sizeTag => {
            sizes.push({
                size: sizeTag.dataset.size,
                stock: parseInt(sizeTag.dataset.stock)
            });
        });
        
        variants.push({ color, sizes });
    });
    
    document.getElementById('editProductVariants').value = JSON.stringify(variants);
}

function setupEditProductMedia(images, video) {
    const imagesPreview = document.getElementById('editImagesPreviewContainer');
    const videoPreview = document.getElementById('editVideoPreviewContainer');
    const imageUpload = document.getElementById('editProductImages');
    const videoUpload = document.getElementById('editProductVideo');
    
    // Clear existing previews
    imagesPreview.innerHTML = '';
    videoPreview.innerHTML = '';
    
    // Track existing media URLs
    const existingMedia = [...images];
    if (video) existingMedia.push(video);
    
    // Add existing images
    images.forEach((image, index) => {
        addEditProductMediaPreview(image, 'image', index);
    });
    
    // Add existing video if it exists
    if (video) {
        addEditProductMediaPreview(video, 'video', 0);
    }
    
    // Set up image upload
    imageUpload.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        const currentCount = document.querySelectorAll('#editImagesPreviewContainer .media-preview').length;
        
        if (currentCount + files.length > 7) {
            showToast('Maximum 7 images allowed. Please delete some existing images first.', 'error');
            this.value = '';
            return;
        }
        
        files.forEach((file, index) => {
            if (!file.type.startsWith('image/')) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                addEditProductMediaPreview(event.target.result, 'image', currentCount + index);
            };
            reader.readAsDataURL(file);
        });
    });
    
    // Set up video upload
    videoUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file.type.startsWith('video/')) return;
        
        // Check if video already exists
        if (document.querySelector('#editVideoPreviewContainer .media-preview')) {
            showToast('A video already exists. Please delete it before adding a new one.', 'error');
            this.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            addEditProductMediaPreview(event.target.result, 'video', 0);
        };
        reader.readAsDataURL(file);
    });
}

function addEditProductMediaPreview(src, type, index) {
    const container = type === 'image' ? 
        document.getElementById('editImagesPreviewContainer') : 
        document.getElementById('editVideoPreviewContainer');
    
    const preview = document.createElement('div');
    preview.className = 'media-preview';
    
    if (type === 'image') {
        preview.innerHTML = `
            <img src="${src}" alt="Preview">
            <button class="delete-media" data-type="${type}" data-src="${src}">
                <i class="fas fa-times"></i>
            </button>
        `;
    } else {
        preview.innerHTML = `
            <video controls>
                <source src="${src}" type="video/mp4">
            </video>
            <button class="delete-media" data-type="${type}" data-src="${src}">
                <i class="fas fa-times"></i>
            </button>
        `;
    }
    
    container.appendChild(preview);
    
    // Add delete handler
    preview.querySelector('.delete-media').addEventListener('click', function() {
        const src = this.dataset.src;
        const type = this.dataset.type;
        
        // If it's an existing media (URL), add to deleted media list
        if (src.startsWith('http')) {
            const deletedMedia = JSON.parse(document.getElementById('deletedMedia').value || '[]');
            deletedMedia.push(src);
            document.getElementById('deletedMedia').value = JSON.stringify(deletedMedia);
        }
        
        preview.remove();
    });
}

// Update Product Button Handler
document.getElementById('updateProductBtn').addEventListener('click', async function() {
    const form = document.getElementById('editProductForm');
    const formData = new FormData(form);
    
    // Validate required fields
    if (!formData.get('editProductName') || !formData.get('editProductPrice') || 
        !formData.get('editProductStock') || !formData.get('editProductStatus')) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    try {
        setLoading(true);
        
        // Append additional data
        formData.append('productId', state.currentProductId);
        formData.append('features', document.getElementById('editProductFeatures').value);
        formData.append('variants', document.getElementById('editProductVariants').value);
        formData.append('deletedMedia', document.getElementById('deletedMedia').value);
        
        // Append files
        const imageFiles = document.getElementById('editProductImages').files;
        for (let i = 0; i < imageFiles.length; i++) {
            formData.append('images', imageFiles[i]);
        }
        
        const videoFile = document.getElementById('editProductVideo').files[0];
        if (videoFile) {
            formData.append('video', videoFile);
        }
        
        // Handle brand
        const brandSelect = document.getElementById('editProductBrand');
        const brand = brandSelect.value === 'other' ? 
            document.getElementById('addOtherBrandEditInput').value : 
            brandSelect.value;
        formData.append('brand', brand);
        
        // Send request
        const response = await fetch('/crud/update-product', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('Failed to update product');
        }
        
        const data = await response.json();
        
        // Update local state
        const productIndex = state.products.findIndex(p => p.id === data.productId);
        if (productIndex !== -1) {
            state.products[productIndex] = data.updatedProduct;
            populateProductsTable();
        }
        
        showToast('Product updated successfully', 'success');
        editProductModal.classList.remove('active');
        
    } catch (error) {
        showToast(`Error updating product: ${error.message}`, 'error');
        console.error('Error updating product:', error);
    } finally {
        setLoading(false);
    }
});


    // View order details
    function viewOrder(id) {
        const order = state.orders.find(o => o.id === id);
        if (!order) return;
        
        // Set current order status for status updates
        state.currentOrderStatus = order.status;
        
        // Populate order details
        document.getElementById('orderId').textContent = order.id;
        document.getElementById('orderDate').textContent = new Date(order.order_timestamp).toLocaleString();
        document.getElementById('orderStatus').textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
        document.getElementById('paymentStatus').textContent = order.payment_completed ? 'Completed' : 'Pending';
        document.getElementById('paymentMethod').textContent = order.payment_method;
        document.getElementById('transactionCode').textContent = order.transaction_code || 'N/A';
        
        // Populate customer info
        const customer = order.customer_info;
        document.getElementById('customerName').textContent = `${customer.firstname} ${customer.lastname}`;
        document.getElementById('customerEmail').textContent = customer.email;
        document.getElementById('customerPhone').textContent = customer.telephone;
        document.getElementById('deliveryMethod').textContent = customer.delivery_method;
        //document.getElementById('deliveryAddress').textContent = customer.delivery_address.delivery_address;
        document.getElementById('packagingInstructions').textContent = customer.packaging_instructions;
        
        // Populate order items
        const orderItemsTable = document.getElementById('orderItems');
        orderItemsTable.innerHTML = '';
        
        order.items.forEach(item => {
            // Find product details
            const product = state.products.find(p => p.id === item.id) || {
                name: `Product ${item.id}`,
                price: 0
            };
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>KES ${formatNumber(Number(product.price))}</td>
                <td>${item.quantity}</td>
                <td>KES ${formatNumber((product.price * item.quantity))}</td>
            `;
            orderItemsTable.appendChild(row);
        });
        
        // Set order totals
        document.getElementById('orderSubtotal').textContent = `KES ${formatNumber(Number(order.subtotal))}`;
        document.getElementById('orderDeliveryFee').textContent = `KES ${formatNumber(Number(order.delivery_fee))}`;
        document.getElementById('orderTotal').textContent = `KES ${formatNumber(Number(order.total))}`;
        
        // Show/hide cancel button based on order status
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        if (order.status === 'pending' || order.status === 'processing') {
            cancelOrderBtn.style.display = 'inline-flex';
        } else {
            cancelOrderBtn.style.display = 'none';
        }
        
        // Show the modal
        orderDetailsModal.classList.add('active');
    }

    // Populate next status options for order
    function populateNextStatusOptions() {
        const orderId =  document.getElementById('orderUpdateId');
        const statusSelect = document.getElementById('newOrderStatus');
        orderId.value = state.currentOrderUpdateId;
        statusSelect.innerHTML = '';
        
        if (!state.currentOrderStatus) {
            alert('select proper id');
            return;
        }
        
        const statusFlow = ['pending', 'processing', 'shipped', 'completed'];
        const currentIndex = statusFlow.indexOf(state.currentOrderStatus);
        
        if (currentIndex === -1) return;
        
        // Only show next statuses in the flow
        for (let i = currentIndex + 1; i < statusFlow.length; i++) {
            const option = document.createElement('option');
            option.value = statusFlow[i];
            option.textContent = statusFlow[i].charAt(0).toUpperCase() + statusFlow[i].slice(1);
            statusSelect.appendChild(option);
        }
        
        // Add cancelled option if not completed
        if (state.currentOrderStatus !== 'completed') {
            const cancelOption = document.createElement('option');
            cancelOption.value = 'cancelled';
            cancelOption.textContent = 'Cancelled';
            statusSelect.appendChild(cancelOption);
        }
    }

    // Update order status
    async function updateOrderStatus() {
        const orderId =  state.currentOrderUpdateId;
        const newStatus = document.getElementById('newOrderStatus').value;
        const notes = document.getElementById('statusNotes').value;
        
        if (!newStatus || !orderId){
            alert('input correct order status: ')
            return;
        }
        
        try {
            setLoading(true);
            
            const response = await fetch('/crud/update-order-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: orderId,
                    newStatus,
                    notes
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update order status');
            }
            
            const data = await response.json();
            
            // Update local state
            const orderIndex = state.orders.findIndex(o => o.id === state.currentOrderId);
            if (orderIndex !== -1) {
                state.orders[orderIndex].status = newStatus;
                populateOrdersTable();
            }
            
            showToast(`Order status updated to ${newStatus}`, 'success');
            updateStatusModal.classList.remove('active');
            orderDetailsModal.classList.remove('active');
            
        } catch (error) {
            showToast(`Error updating order status: ${error.message}`, 'error');
            console.error('Error updating order status:', error);
        } finally {
            setLoading(false);
        }
    }

    // Cancel current order
    async function cancelCurrentOrder() {
        if (!state.currentOrderId) return;
        
        try {
            setLoading(true);
            
            const response = await fetch('/crud/cancel-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: state.currentOrderId
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to cancel order');
            }
            
            const data = await response.json();
            
            // Update local state
            const orderIndex = state.orders.findIndex(o => o.id === state.currentOrderId);
            if (orderIndex !== -1) {
                state.orders[orderIndex].status = 'cancelled';
                populateOrdersTable();
            }
            
            showToast('Order cancelled successfully', 'success');
            orderDetailsModal.classList.remove('active');
            
        } catch (error) {
            showToast(`Error cancelling order: ${error.message}`, 'error');
            console.error('Error cancelling order:', error);
        } finally {
            setLoading(false);
        }
    }

    // Toggle product status (active/inactive)
    async function toggleProductStatus(id, newStatus) {
        try {
            setLoading(true);
            
            const response = await fetch('/crud/update-product-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: id,
                    newStatus
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update product status');
            }
            
            const data = await response.json();
            
            // Update local state
            const productIndex = state.products.findIndex(p => p.id === id);
            if (productIndex !== -1) {
                state.products[productIndex].status = newStatus;
                populateProductsTable();
            }
            
            showToast(`Product status updated to ${newStatus}`, 'success');
            
        } catch (error) {
            showToast(`Error updating product status: ${error.message}`, 'error');
            console.error('Error updating product status:', error);
        } finally {
            setLoading(false);
        }
    }

    // Delete product
    async function deleteProduct(id) {
        try {
            setLoading(true);
            
            const response = await fetch('/crud/delete-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    productId: id
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete product');
            }
            
            const data = await response.json();
            
            // Update local state
            state.products = state.products.filter(p => p.id !== data.productId);
            populateProductsTable();
            
            showToast('Product deleted successfully', 'success');
            
        } catch (error) {
            showToast(`Error deleting product: ${error.message}`, 'error');
            console.error('Error deleting product:', error);
        } finally {
            setLoading(false);
        }
    }


     async function postProductToServer(productData) {
                try {
                    let brand = productData.brand;
                    if (productData.otherBrand) {
                        brand = productData.otherBrand;
                    }
                    // Create FormData object to handle file uploads
                    const formData = new FormData();

                    // Add all product data to FormData
                    formData.append('category', productData.category);
                    formData.append('subcategory', productData.subcategory);
                    formData.append('productClass', productData.productClass);
                    formData.append('brand', productData.brand);
                    formData.append('name', productData.name);
                    formData.append('price', productData.price);
                    formData.append('discount', productData.discount);
                    formData.append('stock', productData.stock);
                    formData.append('status', productData.status);
                    formData.append('badge', productData.badge);
                    formData.append('features', JSON.stringify(productData.features));
                    formData.append('description', productData.description);
                    formData.append('variants', JSON.stringify(productData.variants));

                    // Add image files
                    const imagesInput = document.getElementById('addProductImages');
                    for (let i = 0; i < imagesInput.files.length; i++) {
                        formData.append('productImages', imagesInput.files[i]);
                    }

                    // Add video file if exists
                    const videoInput = document.getElementById('addProductVideo');
                    if (videoInput.files.length > 0) {
                        formData.append('productVideo', videoInput.files[0]);
                    }

                    // Send to backend
                    const response = await fetch('/crud/add-product', {
                        method: 'POST',
                        body: formData
                        // Headers are automatically set by browser for FormData
                    });

                    if (!response.ok) {
                        throw new Error('Server responded with error');
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error posting product:', error);
                    throw error; // Re-throw to be handled by caller
                }
            }

            // Modified addProduct function that uses the backend
            async function saveNewProduct() {

            const saveBtn = document.getElementById('saveNewProductBtn');
            saveBtn.classList.add('loading');
            saveBtn.disabled = true;

            const category = document.getElementById(`addProductCategory`).value;
            const subcategory = document.getElementById(`addProductSubcategory`).value;
            const productClass = document.getElementById(`addProductClass`).value;
            let brand = document.getElementById(`addProductBrand`).value; 
            if (brand === 'other') {
                brand = document.getElementById(`addOtherBrandInput`).value;
            }    
            const name = document.getElementById(`addProductName`).value;
            const price = parseFloat(document.getElementById(`addProductPrice`).value);
            const discount = parseInt(document.getElementById(`addProductDiscount`).value) || 0;
            const stock = parseInt(document.getElementById(`addProductStock`).value);
            const status = document.getElementById(`addProductStatus`).value;
            const badge = document.getElementById(`addProductBadge`).value || null;
            const description = document.getElementById(`addProductDescription`).value;
            //const features = JSON.parse(document.getElementById('productFeatures').value || '[]');
            const features = [];
            document.querySelectorAll(`#addFeaturesList .feature-tag`).forEach(tag => {
                features.push(tag.textContent.replace('', '').trim());
            });
            // Get variants if enabled
            let variants = [];
            if (document.getElementById(`addHasVariantsToggle`).checked) {
                document.querySelectorAll(`#addVariantsContainer .color-variant`).forEach(variant => {
                    const color = variant.querySelector('.color-name').textContent;
                    const sizes = [];
                    
                    variant.querySelectorAll('.size-tag').forEach(sizeTag => {
                        sizes.push(sizeTag.textContent.replace('', '').trim());
                    });
                    
                    if (color && sizes.length > 0) {
                        variants.push({
                            color: color,
                            sizes: sizes
                        });
                    }
                });
            }
            
            // Get images (in a real app, you would upload these to a server)
            const images = [];
            document.querySelectorAll(`#addImagesPreviewContainer .media-preview img`).forEach(img => {
                images.push(img.src);
            });
            
            // Get video (in a real app, you would upload this to a server)
            let video = null;
            const videoPreview = document.querySelector(`#addVideoPreviewContainer video`);
            if (videoPreview) {
                video = videoPreview.querySelector('source').src;
            }
           
            // Validate required fields
            if (!category || !subcategory || !productClass || !brand || !name || isNaN(price) || isNaN(stock)) {
                showToast('Please fill in all required fields', 'error');
                saveBtn.classList.remove('loading');
                saveBtn.disabled = false;
                return;
            }
                    

                // Prepare product data object
                const productData = {
                 category, 
                 subcategory,
                 productClass,
                 brand,
                 name,
                 price, 
                 discount,
                 stock,
                 status,
                 badge,
                 features,
                 description, 
                 variants 
                };

                // Check for images (original validation)
                const imagesInput = document.getElementById('addProductImages');
                if (imagesInput.files.length === 0) {
                    alert('At least one product image is required');
                    return;
                }

                try {
                    // Post to server instead of local array
                    const result = await postProductToServer(productData);

                    // On success, add to local array (matching original behavior)
                    state.products.push(result.product);
                        populateProductsTable();
                        
                        showToast('Product added successfully!', 'success');
                        addProductModal.classList.remove('active');
                        
                    } catch (error) {
                        showToast(`Error adding product: ${error.message}`, 'error');
                        console.error('Error adding product:', error);
                    } finally {
                        setLoading(false);
                    }
            }




    // Update product
    function editProduct(id) {
    const product = state.products.find(p => p.id === id);
    if (!product) return;

    // Reset form first
    resetEditProductForm();

    // Populate basic fields
    document.getElementById('editProductName').value = product.name;
    document.getElementById('editProductPrice').value = product.price;
    document.getElementById('editProductDiscount').value = product.discount || 0;
    document.getElementById('editProductStock').value = product.stock;
    document.getElementById('editProductStatus').value = product.status;
    document.getElementById('editProductBadge').value = product.badge || '';
    document.getElementById('editProductDescription').value = product.description;

    // Populate category dropdowns
    populateEditProductCategoryDropdowns(product.category, product.subcategory, product.class);

    // Populate brand dropdown
    setupEditProductBrandDropdown(product.brand);

    // Populate features
    populateEditProductFeatures(product.features || []);

    // Handle variants
    setupEditProductVariants(product.variations || []);

    // Handle media (images and video)
    setupEditProductMedia(product.images || [], product.video);

    // Show the modal
    editProductModal.classList.add('active');
    }

    
// Show subscription modal
function showSubscriptionModal() {
    const modal = document.getElementById('subscriptionModal');
    const currentPlan = document.getElementById('currentPlanName');
    const currentExpiry = document.getElementById('currentPlanExpiry');
    
    // Populate current subscription info
    if (state.merchant && state.merchant.subscription_plan) {
        const sub = state.merchant.subscription_plan;
        currentPlan.textContent = sub.plan.charAt(0).toUpperCase() + sub.plan.slice(1);
        
        const expiryDate = new Date(sub.expiry.year, sub.expiry.month - 1, sub.expiry.day);
        currentExpiry.textContent = expiryDate.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }
    
    // Calculate and update payment summary
    updateSubscriptionSummary();
    
    modal.classList.add('active');
}

// Update subscription summary based on selections
function updateSubscriptionSummary() {
    const action = document.querySelector('input[name="subscriptionType"]:checked').value;
    const period = document.getElementById('subscriptionPeriod').value;
    const upgradeOptions = document.getElementById('upgradeOptions');
    const upgradeSavings = document.getElementById('upgradeSavings');
    
    // Show/hide upgrade options
    if (action === 'upgrade') {
        upgradeOptions.style.display = 'block';
        
        // Show savings if upgrading an active subscription
        if (state.merchant.subscription_plan && state.merchant.subscription_plan.status === 'active') {
            calculateUpgradeSavings();
            upgradeSavings.style.display = 'block';
        } else {
            upgradeSavings.style.display = 'none';
        }
    } else {
        upgradeOptions.style.display = 'none';
        upgradeSavings.style.display = 'none';
    }
    
    // Calculate payment amount and new expiry date
    const { amount, expiryDate } = calculateSubscriptionPayment(action, period);
    
    // Update UI
    document.getElementById('paymentAmount').textContent = `KSh ${formatNumber(amount)}`;
    document.getElementById('newExpiryDate').textContent = expiryDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

// Calculate upgrade savings
function calculateUpgradeSavings() {
    const currentSub = state.merchant.subscription_plan;
    const currentPlan = currentSub.plan;
    const newPlan = document.getElementById('subscriptionPlanChoice').value;
    const period = document.getElementById('subscriptionPeriod').value;
    
    // Plan prices (in KSh)
    const planPrices = {
        'starter': 499,
        'plus': 2499,
        'pro': 4999
    };
    
    // Skip if same plan
    if (currentPlan === newPlan) return;
    
    // Calculate remaining value of current subscription
    const currentStart = new Date(currentSub.from.year, currentSub.from.month - 1, currentSub.from.day);
    const currentEnd = new Date(currentSub.expiry.year, currentSub.expiry.month - 1, currentSub.expiry.day);
    const currentTotalDays = Math.ceil((currentEnd - currentStart) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.ceil((currentEnd - new Date()) / (1000 * 60 * 60 * 24));
    
    const currentTotalPaid = currentSub.payment;
    const remainingValue = Math.round((daysRemaining / currentTotalDays) * currentTotalPaid);
    
    // Calculate new plan cost
    let newPlanPrice = planPrices[newPlan];
    
    // Apply period discount
    if (period === 'quarterly') {
        newPlanPrice = newPlanPrice * 3 * 0.9; // 10% discount
    } else if (period === 'yearly') {
        newPlanPrice = newPlanPrice * 12 * 0.8; // 20% discount
    } else {
        newPlanPrice = newPlanPrice; // Monthly
    }
    
    // Calculate final amount and savings
    const finalAmount = newPlanPrice - remainingValue;
    const savings = remainingValue;
    const savingsPercent = Math.round((savings / newPlanPrice) * 100);
    
    // Update UI
    document.getElementById('savingsText').textContent = `Upgrade today and save KSh ${formatNumber(savings)} (${savingsPercent}%)!`;
    document.getElementById('originalPrice').textContent = `KSh ${formatNumber(newPlanPrice)}`;
    document.getElementById('discountedPrice').textContent = `KSh ${formatNumber(finalAmount)}`;
}

// Calculate subscription payment details
function calculateSubscriptionPayment(action, period) {
    const currentSub = state.merchant.subscription_plan;
    const today = new Date();
    let amount = 0;
    let expiryDate = new Date();
    
    // Plan prices (in KSh)
    const planPrices = {
        'starter': 499,
        'plus': 2499,
        'pro': 4999
    };
    
    if (action === 'extend') {
        // Extend current plan
        const currentPrice = planPrices[currentSub.plan];
        
        // Calculate amount with period discount
        if (period === 'monthly') {
            amount = currentPrice;
            expiryDate = new Date(today);
            expiryDate.setMonth(expiryDate.getMonth() + 1);
        } else if (period === 'quarterly') {
            amount = currentPrice * 3 * 0.9; // 10% discount
            expiryDate = new Date(today);
            expiryDate.setMonth(expiryDate.getMonth() + 3);
        } else if (period === 'yearly') {
            amount = currentPrice * 12 * 0.8; // 20% discount
            expiryDate = new Date(today);
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
        }
        
        // If extending an existing subscription, start from current expiry
        if (currentSub.subscription === 'active') {
            const currentExpiry = new Date(currentSub.expiry.year, currentSub.expiry.month - 1, currentSub.expiry.day);
            expiryDate = new Date(currentExpiry);
            
            if (period === 'monthly') {
                expiryDate.setMonth(expiryDate.getMonth() + 1);
            } else if (period === 'quarterly') {
                expiryDate.setMonth(expiryDate.getMonth() + 3);
            } else if (period === 'yearly') {
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
            }
        }
    } else {
  
        // Upgrade to new plan
        const newPlan = document.getElementById('subscriptionPlanChoice').value;
        let newPlanPrice = planPrices[newPlan];
        
        // Apply period discount
        if (period === 'monthly') {
            amount = newPlanPrice;
            expiryDate = new Date(today);
            expiryDate.setMonth(expiryDate.getMonth() + 1);
        } else if (period === 'quarterly') {
            amount = newPlanPrice * 3 * 0.9; // 10% discount
            expiryDate = new Date(today);
            expiryDate.setMonth(expiryDate.getMonth() + 3);
        } else if (period === 'yearly') {
            amount = newPlanPrice * 12 * 0.8; // 20% discount
            expiryDate = new Date(today);
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
        }
        
        // If upgrading from active subscription, apply credit
        if (currentSub.subscription === 'active') {
            const currentStart = new Date(currentSub.from.year, currentSub.from.month - 1, currentSub.from.day);
            const currentEnd = new Date(currentSub.expiry.year, currentSub.expiry.month - 1, currentSub.expiry.day);
            const currentTotalDays = Math.ceil((currentEnd - currentStart) / (1000 * 60 * 60 * 24));
            const daysRemaining = Math.ceil((currentEnd - today) / (1000 * 60 * 60 * 24));
            
            const currentTotalPaid = currentSub.payment;
            const remainingValue = Math.round((daysRemaining / currentTotalDays) * currentTotalPaid);
            
            amount = Math.round(Math.max(0, amount - remainingValue));
        }
    }
    
    return { amount, expiryDate };
}

// Event listeners for subscription modal
document.querySelectorAll('input[name="subscriptionType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // Hide/show upgrade options based on selection
        document.getElementById('upgradeOptions').style.display = 
            this.value === 'upgrade' ? 'block' : 'none';
        updateSubscriptionSummary();
    });
});

document.getElementById('subscriptionPeriod').addEventListener('change', updateSubscriptionSummary);
//document.getElementById('subscriptionPlan').addEventListener('change', updateSubscriptionSummary);



    // Show subscription payment modal
    function showSubscriptionPaymentModal() {
        const planCard = this.closest('.plan-card');
        const planName = planCard.querySelector('.plan-name').textContent;
        const planPrice = planCard.querySelector('.plan-price').textContent;
        const planFeatures = Array.from(planCard.querySelectorAll('.plan-feature span')).map(el => el.textContent);
        
        // Populate the payment modal
        document.getElementById('selectedPlanName').textContent = planName;
        document.getElementById('selectedPlanPrice').textContent = planPrice;
        
        const featuresContainer = document.getElementById('selectedPlanFeatures');
        featuresContainer.innerHTML = '';
        planFeatures.forEach(feature => {
            const div = document.createElement('div');
            div.style.marginBottom = '0.25rem';
            div.innerHTML = `<i class="fas fa-check" style="color: var(--success); margin-right: 0.5rem;"></i>${feature}`;
            featuresContainer.appendChild(div);
        });
        
        // Show the modal
        subscriptionPaymentModal.classList.add('active');
    }


    // Submit subscription request
document.getElementById('submitSubscriptionBtn').addEventListener('click', async function() {
    const action = document.querySelector('input[name="subscriptionType"]:checked').value;
    const period = document.getElementById('subscriptionPeriod').value;
    let plan = state.merchant.subscription_plan.plan;
    
    if (action === 'upgrade') {
        plan = document.getElementById('subscriptionPlanChoice').value;
    }
    
    try {
        setLoading(true);
        
        const response = await fetch('/fetch/place-subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action,
                plan,
                period
            })
        });
        
        const data = await response.json();
        console.log(data);
        
        if (data.success) {
            showToast('Subscription processed successfully!', 'success');
            document.getElementById('subscriptionModal').classList.remove('active');
            const paymentIframeModal = document.getElementById('paymentIframeModal');
            const paymentIframe = document.getElementById('paymentFrame');
            // Redirect to payment page if URL provided
            if (data.data.paymentUrl) {
                paymentIframe.src = data.data.paymentUrl;
                paymentIframeModal.classList.add('active');
            } else {
                // Refresh merchant data
                showToast('We are having some trouble processing your payment, and we are working to fix that.please retry after 5 minutes' , 'error');
               // await fetchMerchantData();
            }
        } else {
            showToast(data.message || 'Failed to process subscription', 'error');
        }
    } catch (error) {
        showToast('Error processing subscription: ' + error.message, 'error');
        console.error('Subscription error:', error);
    } finally {
        setLoading(false);
    }
});

    // Toggle payment method sections
    function togglePaymentMethodSections() {
        document.getElementById('mpesaPaymentSection').style.display = this.value === 'mpesa' ? 'block' : 'none';
        document.getElementById('cardPaymentSection').style.display = this.value === 'card' ? 'block' : 'none';
    }

    // Initiate M-Pesa payment
    async function initiateMpesaPayment() {
        const phoneNumber = document.getElementById('mpesaPhoneNumber').value.trim();
        
        if (!phoneNumber) {
            showToast('Please enter your M-Pesa phone number', 'error');
            return;
        }
        
        try {
            setLoading(true, this);
            
            // Here you would typically initiate the payment process with the server
            const response = await fetch('/crud/initiate-mpesa-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phoneNumber,
                    amount: parseFloat(document.getElementById('selectedPlanPrice').textContent.replace('KES ', '').replace(',', ''))
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to initiate M-Pesa payment');
            }
            
            const data = await response.json();
            
            showToast('Payment initiated. Please check your phone to complete the transaction', 'info');
            
            // Simulate payment completion after 3 seconds
            setTimeout(() => {
                subscriptionPaymentModal.classList.remove('active');
                showToast('Payment completed successfully! Your subscription has been upgraded', 'success');
                
                // Update merchant subscription in state
                if (state.merchant) {
                    state.merchant.subscription_plan = document.getElementById('selectedPlanName').textContent;
                }
            }, 3000);
            
        } catch (error) {
            showToast(`Error initiating payment: ${error.message}`, 'error');
            console.error('Error initiating M-Pesa payment:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Process card payment
    async function processCardPayment() {
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const cardExpiry = document.getElementById('cardExpiry').value.trim();
        const cardCvc = document.getElementById('cardCvc').value.trim();
        
        if (!cardNumber || !cardExpiry || !cardCvc) {
            showToast('Please fill in all card details', 'error');
            return;
        }
        
        try {
            setLoading(true, this);
            
            // Here you would typically process the card payment with the server
            const response = await fetch('/crud/process-card-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cardNumber,
                    cardExpiry,
                    cardCvc,
                    amount: parseFloat(document.getElementById('selectedPlanPrice').textContent.replace('KES ', '').replace(',', ''))
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to process card payment');
            }
            
            const data = await response.json();
            
            showToast('Processing payment...', 'info');
            
            // Simulate payment completion after 2 seconds
            setTimeout(() => {
                subscriptionPaymentModal.classList.remove('active');
                showToast('Payment completed successfully! Your subscription has been upgraded', 'success');
                
                // Update merchant subscription in state
                if (state.merchant) {
                    state.merchant.subscription_plan = document.getElementById('selectedPlanName').textContent;
                }
            }, 2000);
            
        } catch (error) {
            showToast(`Error processing payment: ${error.message}`, 'error');
            console.error('Error processing card payment:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Toggle payout method sections
    function togglePayoutMethodSections() {
        document.getElementById('bankDetailsSection').style.display = this.value === 'bank' ? 'block' : 'none';
        document.getElementById('mpesaDetailsSection').style.display = this.value === 'mpesa' ? 'block' : 'none';
    }


// Show withdrawal modal
function showWithdrawalModal() {
    const modal = document.getElementById('withdrawalModal');
    const balance = parseFloat(document.querySelector('.balance-amount').textContent.replace('KES ', ''));
    
    document.getElementById('availableBalance').textContent = `KES ${balance.toFixed(2)}`;
    document.getElementById('withdrawalAmount').value = '';
    document.getElementById('withdrawalError').style.display = 'none';
    
    modal.classList.add('active');
}

// Validate withdrawal amount
function validateWithdrawalAmount() {
    const amountInput = document.getElementById('withdrawalAmount');
    const errorElement = document.getElementById('withdrawalError');
    const amount = parseFloat(amountInput.value);
    const balance = parseFloat(document.getElementById('availableBalance').textContent.replace('KES ', ''));
    
    errorElement.style.display = 'none';
    amountInput.style.borderColor = 'var(--border-color)';
    
    if (isNaN(amount)) {
        errorElement.textContent = 'Please enter a valid amount';
        errorElement.style.display = 'block';
        amountInput.style.borderColor = 'var(--danger)';
        return false;
    }
    
    if (amount < 500) {
        errorElement.textContent = 'Minimum withdrawal amount is KES 500';
        errorElement.style.display = 'block';
        amountInput.style.borderColor = 'var(--danger)';
        return false;
    }
    
    if (amount > balance) {
        errorElement.textContent = 'Insufficient balance for this withdrawal';
        errorElement.style.display = 'block';
        amountInput.style.borderColor = 'var(--danger)';
        return false;
    }
    
    return true;
}

// Submit withdrawal request
async function submitWithdrawal() {
    if (!validateWithdrawalAmount()) return;
    
    const amount = parseFloat(document.getElementById('withdrawalAmount').value);
    
    try {
        setLoading(true);
        
        const response = await fetch('/fetch/submit-merchant-withdrawal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: amount
            })
        });
        
        const data = await response.json();
        console.log(data)
        if (response.status === 400 || response.status === 400 || response.status !== 200) {
            showToast(`${data.message}`, 'error');
        }
        
        if (!response.ok) {
            throw new Error('Failed to submit withdrawal request');
        }
        
        // Update balance in UI
        document.querySelector('.balance-amount').textContent = `KES ${data.newBalance.toFixed(2)}`;
        document.getElementById('processing-payouts-amount').textContent = `KES ${data.withdrawalRequest.toFixed(2)}`;
        document.getElementById('withdrawalModal').classList.remove('active');
        
        showToast(`Withdrawal request of KES ${amount.toFixed(2)} submitted successfully!`, 'success');
        
        // Refresh transactions table
        await fetchMerchantData();
        
    } catch (error) {
        showToast(`Error submitting withdrawal: ${error.message}`, 'error');
        console.error('Error submitting withdrawal:', error);
    } finally {
        setLoading(false);
    }
}





    // Submit payout request
    async function submitPayoutRequest() {
        const amount = parseFloat(document.getElementById('payoutAmount').value);
        const method = document.getElementById('payoutMethod').value;
        
        if (!amount || amount <= 0) {
            showToast('Please enter a valid amount', 'error');
            return;
        }
        
        if (!method) {
            showToast('Please select a payout method', 'error');
            return;
        }
        
        // Validate method-specific details
        let payoutDetails = {};
        if (method === 'bank') {
            const bankName = document.getElementById('bankName').value.trim();
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const accountName = document.getElementById('accountName').value.trim();
            
            if (!bankName || !accountNumber || !accountName) {
                showToast('Please fill in all bank details', 'error');
                return;
            }
            
            payoutDetails = {
                bankName,
                accountNumber,
                accountName
            };
        } else if (method === 'mpesa') {
            const mpesaNumber = document.getElementById('mpesaNumber').value.trim();
            
            if (!mpesaNumber) {
                showToast('Please enter your M-Pesa phone number', 'error');
                return;
            }
            
            payoutDetails = {
                mpesaNumber
            };
        }
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/request-merchant-payout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount,
                    method,
                    ...payoutDetails
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to submit payout request');
            }
            
            const data = await response.json();
            
            // Update local state with new pending transaction
            if (state.merchant) {
                if (!state.merchant.pending_transactions) {
                    state.merchant.pending_transactions = [];
                }
                
                state.merchant.pending_transactions.push({
                    amount,
                    method,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                });
                
                // Update cash balance
                state.merchant.cash_balance = (parseFloat(state.merchant.cash_balance) - amount).toFixed(2);
                
                // Update UI
                document.querySelector('.balance-amount').textContent = `KES ${state.merchant.cash_balance}`;
                populatePayoutsTable();
            }
            
            showToast('Payout request submitted successfully', 'success');
            
            // Reset the form
            document.getElementById('payoutAmount').value = '';
            document.getElementById('payoutMethod').value = '';
            document.getElementById('bankDetailsSection').style.display = 'none';
            document.getElementById('mpesaDetailsSection').style.display = 'none';
            
        } catch (error) {
            showToast(`Error submitting payout request: ${error.message}`, 'error');
            console.error('Error submitting payout request:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save general settings
    async function saveGeneralSettings() {
        const storeName = document.getElementById('storeName').value.trim();
        const storeEmail = document.getElementById('storeEmail').value.trim();
        const storePhone = document.getElementById('storePhone').value.trim();
        const storeAddress = document.getElementById('storeAddress').value.trim();
        
        if (!storeName || !storeEmail) {
            showToast('Store name and email are required', 'error');
            return;
        }
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/save-general-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    storeName,
                    storeEmail,
                    storePhone,
                    storeAddress
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save general settings');
            }
            
            const data = await response.json();
            
            // Update local state
            if (state.merchant) {
                state.merchant.store_name = storeName;
                state.merchant.email = storeEmail;
                state.merchant.telephone = storePhone;
            }
            
            showToast('General settings saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving general settings: ${error.message}`, 'error');
            console.error('Error saving general settings:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save social settings
    async function saveSocialSettings() {
        const facebookUrl = document.getElementById('facebookUrl').value.trim();
        const instagramUrl = document.getElementById('instagramUrl').value.trim();
        const twitterUrl = document.getElementById('twitterUrl').value.trim();
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/save-social-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    facebookUrl,
                    instagramUrl,
                    twitterUrl
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save social settings');
            }
            
            const data = await response.json();
            
            // Update local state
            if (state.merchant) {
                state.merchant.social_handles = JSON.stringify({
                    facebook: facebookUrl,
                    instagram: instagramUrl,
                    twitter: twitterUrl
                });
            }
            
            showToast('Social media settings saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving social settings: ${error.message}`, 'error');
            console.error('Error saving social settings:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save logo
    async function saveLogo() {
        const logoFile = document.getElementById('storeLogo').files[0];
        
        if (!logoFile) {
            showToast('Please select a logo file to upload', 'error');
            return;
        }
        
        try {
            setLoading(true, this);
            
            const formData = new FormData();
            formData.append('logo', logoFile);
            
            const response = await fetch('/crud/save-logo', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Failed to upload logo');
            }
            
            const data = await response.json();
            
            // Update logo preview
            const logoPreviewContainer = document.getElementById('logoPreviewContainer');
            logoPreviewContainer.innerHTML = '';
            
            const preview = document.createElement('div');
            preview.className = 'media-preview';
            preview.innerHTML = `
                <img src="${URL.createObjectURL(logoFile)}" alt="Store Logo">
                <button class="delete-media">
                    <i class="fas fa-times"></i>
                </button>
            `;
            logoPreviewContainer.appendChild(preview);
            
            // Add event listener for delete button
            const deleteBtn = preview.querySelector('.delete-media');
            deleteBtn.addEventListener('click', function() {
                preview.remove();
                document.getElementById('storeLogo').value = '';
            });
            
            showToast('Logo saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving logo: ${error.message}`, 'error');
            console.error('Error saving logo:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save theme settings
    async function saveThemeSettings() {
        const selectedColor = document.querySelector('.color-option.selected');
        if (!selectedColor) {
            showToast('Please select a theme color', 'error');
            return;
        }
        
        const primaryColor = selectedColor.getAttribute('data-color');
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/save-theme-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    primaryColor
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save theme settings');
            }
            
            const data = await response.json();
            
            // Update local state
            if (state.merchant && state.merchant.settings) {
                const settings = JSON.parse(state.merchant.settings);
                settings.theme = { primaryColor };
                state.merchant.settings = JSON.stringify(settings);
            }
            
            showToast('Theme settings saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving theme settings: ${error.message}`, 'error');
            console.error('Error saving theme settings:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save font settings
    async function saveFontSettings() {
        const primaryFont = document.getElementById('primaryFont').value;
        const fontSize = document.getElementById('fontSize').value;
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/save-font-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    primaryFont,
                    fontSize
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save font settings');
            }
            
            const data = await response.json();
            
            // Update local state
            if (state.merchant && state.merchant.settings) {
                const settings = JSON.parse(state.merchant.settings);
                settings.font = { primaryFont, fontSize };
                state.merchant.settings = JSON.stringify(settings);
            }
            
            showToast('Font settings saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving font settings: ${error.message}`, 'error');
            console.error('Error saving font settings:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save payment settings
    async function savePaymentSettings() {
        const usePlatformPayments = document.getElementById('usePlatformPayments').checked;
        const paymentGateway = document.getElementById('paymentGateway').value;
        const pesapalConsumerKey = document.getElementById('pesapalConsumerKey').value;
        const pesapalConsumerSecret = document.getElementById('pesapalConsumerSecret').value;
        
        if (!usePlatformPayments && !paymentGateway) {
            showToast('Please select a payment gateway', 'error');
            return;
        }
        
        if (!usePlatformPayments && paymentGateway === 'pesapal' && (!pesapalConsumerKey || !pesapalConsumerSecret)) {
            showToast('Please enter Pesapal credentials', 'error');
            return;
        }
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/save-payment-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    usePlatformPayments,
                    paymentGateway,
                    pesapalConsumerKey,
                    pesapalConsumerSecret
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save payment settings');
            }
            
            const data = await response.json();
            
            // Update local state
            if (state.merchant && state.merchant.settings) {
                const settings = JSON.parse(state.merchant.settings);
                settings.payments = {
                    usePlatformPayments,
                    paymentGateway,
                    pesapalConsumerKey,
                    pesapalConsumerSecret
                };
                state.merchant.settings = JSON.stringify(settings);
            }
            
            showToast('Payment settings saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving payment settings: ${error.message}`, 'error');
            console.error('Error saving payment settings:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save payout settings
    async function savePayoutSettings() {
        const payoutCurrency = document.getElementById('payoutCurrency').value;
        const payoutSchedule = document.getElementById('payoutSchedule').value;
        const payoutThreshold = document.getElementById('payoutThreshold').value;
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/save-payout-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    payoutCurrency,
                    payoutSchedule,
                    payoutThreshold
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save payout settings');
            }
            
            const data = await response.json();
            
            // Update local state
            if (state.merchant && state.merchant.settings) {
                const settings = JSON.parse(state.merchant.settings);
                settings.payouts = {
                    payoutCurrency,
                    payoutSchedule,
                    payoutThreshold
                };
                state.merchant.settings = JSON.stringify(settings);
            }
            
            showToast('Payout settings saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving payout settings: ${error.message}`, 'error');
            console.error('Error saving payout settings:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Save shipping settings
    async function saveShippingSettings() {
        const enableShipping = document.getElementById('enableShipping').checked;
        const enableFreeShipping = document.getElementById('enableFreeShipping').checked;
        const freeShippingThreshold = document.getElementById('freeShippingThreshold').value;
        const defaultShippingFee = document.getElementById('defaultShippingFee').value;
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/save-shipping-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    enableShipping,
                    enableFreeShipping,
                    freeShippingThreshold,
                    defaultShippingFee
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save shipping settings');
            }
            
            const data = await response.json();
            
            // Update local state
            if (state.merchant && state.merchant.settings) {
                const settings = JSON.parse(state.merchant.settings);
                settings.shipping = {
                    enableShipping,
                    enableFreeShipping,
                    freeShippingThreshold,
                    defaultShippingFee
                };
                state.merchant.settings = JSON.stringify(settings);
            }
            
            showToast('Shipping settings saved successfully', 'success');
            
        } catch (error) {
            showToast(`Error saving shipping settings: ${error.message}`, 'error');
            console.error('Error saving shipping settings:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Add shipping zone
    async function addShippingZone() {
        const zoneName = document.getElementById('shippingZoneName').value.trim();
        const zoneFee = document.getElementById('shippingZoneFee').value.trim();
        const regions = Array.from(document.getElementById('shippingZoneRegions').selectedOptions).map(opt => opt.value);
        
        if (!zoneName || !zoneFee || regions.length === 0) {
            showToast('Please fill in all shipping zone details', 'error');
            return;
        }
        
        try {
            setLoading(true, this);
            
            const response = await fetch('/crud/add-shipping-zone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    zoneName,
                    zoneFee,
                    regions
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to add shipping zone');
            }
            
            const data = await response.json();
            
            // Add to the table
            const row = shippingZonesTable.insertRow();
            row.innerHTML = `
                <td>${zoneName}</td>
                <td>${regions.join(', ')}</td>
                <td>KES ${zoneFee}</td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn edit">
                            <i class="fas fa-edit"></i>
                            <span class="tooltip">Edit</span>
                        </button>
                        <button class="action-btn delete">
                            <i class="fas fa-trash"></i>
                            <span class="tooltip">Delete</span>
                        </button>
                    </div>
                </td>
            `;
            
            // Add event listeners to the new row's buttons
            const editBtn = row.querySelector('.edit');
            const deleteBtn = row.querySelector('.delete');
            
            editBtn.addEventListener('click', function() {
                // In a real app, you would populate a form with the zone details for editing
                showToast('Edit functionality would be implemented here', 'info');
            });
            
            deleteBtn.addEventListener('click', function() {
                showConfirmation('Delete Shipping Zone', 'Are you sure you want to delete this shipping zone?', function() {
                    deleteShippingZone(row, zoneName);
                });
            });
            
            // Reset the form
            document.getElementById('shippingZoneName').value = '';
            document.getElementById('shippingZoneFee').value = '150';
            document.getElementById('shippingZoneRegions').selectedIndex = -1;
            
            showToast('Shipping zone added successfully', 'success');
            
        } catch (error) {
            showToast(`Error adding shipping zone: ${error.message}`, 'error');
            console.error('Error adding shipping zone:', error);
        } finally {
            setLoading(false, this);
        }
    }

    // Delete shipping zone
    async function deleteShippingZone(row, zoneName) {
        try {
            setLoading(true);
            
            const response = await fetch('/crud/delete-shipping-zone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    zoneName
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete shipping zone');
            }
            
            const data = await response.json();
            
            row.remove();
            showToast('Shipping zone deleted successfully', 'success');
            
        } catch (error) {
            showToast(`Error deleting shipping zone: ${error.message}`, 'error');
            console.error('Error deleting shipping zone:', error);
        } finally {
            setLoading(false);
        }
    }

    // Setup product form dropdowns
    function setupProductFormDropdowns() {
        const addProductCategory = document.getElementById('addProductCategory');
        const addProductSubcategory = document.getElementById('addProductSubcategory');
        const addProductClass = document.getElementById('addProductClass');
        const addProductBrand = document.getElementById('addProductBrand');
        const addOtherBrandInput = document.getElementById('addOtherBrandInput');

        addProductCategory.addEventListener('change', function() {
            // Clear and disable subcategory dropdown
            addProductSubcategory.innerHTML = '<option value="">Select Subcategory</option>';
            addProductSubcategory.disabled = true;
            
            // Clear and disable class dropdown
            addProductClass.innerHTML = '<option value="">Select Class</option>';
            addProductClass.disabled = true;
            
            // Clear and disable brand dropdown
            addProductBrand.innerHTML = '<option value="">Select Brand</option>';
            addProductBrand.disabled = true;
            addOtherBrandInput.style.display = 'none';
            
            // Find selected category
            const selectedCategory = categoriesData.categories.find(cat => cat.category === this.value);
            
            if (selectedCategory) {
                // Populate subcategories
                selectedCategory.subcategories.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat.subcategory;
                    option.textContent = subcat.subcategory;
                    addProductSubcategory.appendChild(option);
                });
                
                addProductSubcategory.disabled = false;
            }
        });

        addProductSubcategory.addEventListener('change', function() {
            // Clear and disable class dropdown
            addProductClass.innerHTML = '<option value="">Select Class</option>';
            addProductClass.disabled = true;
            
            // Clear and disable brand dropdown
            addProductBrand.innerHTML = '<option value="">Select Brand</option>';
            addProductBrand.disabled = true;
            addOtherBrandInput.style.display = 'none';
            
            // Find selected category and subcategory
            const selectedCategory = categoriesData.categories.find(cat => cat.category === addProductCategory.value);
            if (selectedCategory) {
                const selectedSubcategory = selectedCategory.subcategories.find(sub => sub.subcategory === this.value);
                
                if (selectedSubcategory) {
                    // Populate classes
                    selectedSubcategory.classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        addProductClass.appendChild(option);
                    });
                    
                    addProductClass.disabled = false;
                }
            }
        });

        addProductClass.addEventListener('change', function() {
            // Clear and disable brand dropdown
            addProductBrand.innerHTML = '<option value="">Select Brand</option>';
            addProductBrand.disabled = true;
            addOtherBrandInput.style.display = 'none';
            
            // Get brands for selected class
            const brands = brandsData[this.value];
            
            if (brands) {
                // Populate brands
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    addProductBrand.appendChild(option);
                });
                
                // Add "Other" option
                const otherOption = document.createElement('option');
                otherOption.value = "other";
                otherOption.textContent = "Other";
                addProductBrand.appendChild(otherOption);
                
                addProductBrand.disabled = false;
            }
        });

        addProductBrand.addEventListener('change', function() {
            if (this.value === "other") {
                addOtherBrandInput.style.display = 'block';
            } else {
                addOtherBrandInput.style.display = 'none';
            }
        });
    }

    // Add color variant
    function addColorVariant() {
        const addColorNameInput = document.getElementById('addColorNameInput');
        const colorName = addColorNameInput.value.trim();
        const colorVariantsContainer = document.getElementById('addColorVariantsContainer');
        
        if (colorName) {
            const colorVariant = document.createElement('div');
            colorVariant.className = 'color-variant';
            colorVariant.innerHTML = `
                <div class="color-header">
                    <span class="color-name">${colorName}</span>
                    <div class="color-actions">
                        <button type="button" class="action-btn delete delete-color">
                            <i class="fas fa-trash"></i>
                            <span class="tooltip">Delete Color</span>
                        </button>
                    </div>
                </div>
                <div class="sizes-list">
                    <!-- Sizes will be added here -->
                </div>
                <div class="add-size-container">
                    <input type="text" class="size-input" placeholder="Size (e.g. S, M, L)">
                    <button type="button" class="btn btn-secondary add-size">Add Size</button>
                </div>
            `;
            colorVariantsContainer.appendChild(colorVariant);
            addColorNameInput.value = '';
            
            // Add event listeners for the new color variant
            const deleteColorBtn = colorVariant.querySelector('.delete-color');
            deleteColorBtn.addEventListener('click', function() {
                colorVariant.remove();
            });
            
            const addSizeBtn = colorVariant.querySelector('.add-size');
            addSizeBtn.addEventListener('click', function() {
                const sizeInput = colorVariant.querySelector('.size-input');
                const size = sizeInput.value.trim();
                if (size) {
                    const sizesList = colorVariant.querySelector('.sizes-list');
                    const sizeTag = document.createElement('div');
                    sizeTag.className = 'size-tag';
                    sizeTag.innerHTML = `
                        <span>${size}</span>
                        <button class="delete-size">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    sizesList.appendChild(sizeTag);
                    sizeInput.value = '';
                    
                    // Add event listener for delete size button
                    const deleteSizeBtn = sizeTag.querySelector('.delete-size');
                    deleteSizeBtn.addEventListener('click', function() {
                        sizeTag.remove();
                    });
                }
            });
        }
    }

    // Add product feature
    function addProductFeature() {
        const addFeatureInput = document.getElementById('addFeatureInput');
        const feature = addFeatureInput.value.trim();
        const featuresList = document.getElementById('addFeaturesList');
        
        if (feature) {
            const featureTag = document.createElement('div');
            featureTag.className = 'feature-tag';
            featureTag.innerHTML = `
                <span>${feature}</span>
                <button class="delete-feature">
                    <i class="fas fa-times"></i>
                </button>
            `;
            featuresList.appendChild(featureTag);
            addFeatureInput.value = '';
            
            // Add event listener for delete feature button
            const deleteFeatureBtn = featureTag.querySelector('.delete-feature');
            deleteFeatureBtn.addEventListener('click', function() {
                featureTag.remove();
            });
        }
    }

    // Setup image upload
    function setupImageUpload() {
        const imageUploadArea = document.getElementById('addImageUploadArea');
        const productImagesInput = document.getElementById('addProductImages');
        const imagesPreviewContainer = document.getElementById('addImagesPreviewContainer');

        imageUploadArea.addEventListener('click', function() {
            productImagesInput.click();
        });

        imageUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.backgroundColor = 'var(--primary-light)';
        });

        imageUploadArea.addEventListener('dragleave', function() {
            this.style.borderColor = 'var(--border-color)';
            this.style.backgroundColor = '';
        });

        imageUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--border-color)';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length > 0) {
                productImagesInput.files = e.dataTransfer.files;
                handleImageUpload(productImagesInput.files);
            }
        });

        productImagesInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleImageUpload(this.files);
            }
        });

        function handleImageUpload(files) {
            // Clear existing previews if needed
            imagesPreviewContainer.innerHTML = '';
            
            // Limit to 7 images
            const filesToUpload = Array.from(files).slice(0, 7);
            
            filesToUpload.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.createElement('div');
                        preview.className = 'media-preview';
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="Product Image">
                            <button class="delete-media">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        imagesPreviewContainer.appendChild(preview);
                        
                        // Add event listener for delete button
                        const deleteBtn = preview.querySelector('.delete-media');
                        deleteBtn.addEventListener('click', function() {
                            preview.remove();
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }

    // Setup video upload
    function setupVideoUpload() {
        const videoUploadArea = document.getElementById('addVideoUploadArea');
        const productVideoInput = document.getElementById('addProductVideo');
        const videoPreviewContainer = document.getElementById('addVideoPreviewContainer');

        videoUploadArea.addEventListener('click', function() {
            productVideoInput.click();
        });

        productVideoInput.addEventListener('change', function() {
            if (this.files.length > 0 && this.files[0].type.startsWith('video/')) {
                const file = this.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    videoPreviewContainer.innerHTML = '';
                    const preview = document.createElement('div');
                    preview.className = 'media-preview';
                    preview.innerHTML = `
                        <video controls>
                            <source src="${e.target.result}" type="${file.type}">
                            Your browser does not support the video tag.
                        </video>
                        <button class="delete-media">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    videoPreviewContainer.appendChild(preview);
                    
                    // Add event listener for delete button
                    const deleteBtn = preview.querySelector('.delete-media');
                    deleteBtn.addEventListener('click', function() {
                        preview.remove();
                        productVideoInput.value = '';
                    });
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Validate product form
    function validateProductForm() {
        // Basic validation - you can expand this
        if (!document.getElementById('addProductName').value) {
            showToast('Please enter a product name', 'error');
            return false;
        }
        
        if (!document.getElementById('addProductCategory').value) {
            showToast('Please select a category', 'error');
            return false;
        }
        
        if (!document.getElementById('addProductSubcategory').value) {
            showToast('Please select a subcategory', 'error');
            return false;
        }
        
        if (!document.getElementById('addProductClass').value) {
            showToast('Please select a class', 'error');
            return false;
        }
        
        if (!document.getElementById('addProductBrand').value || 
            (document.getElementById('addProductBrand').value === "other" && !document.getElementById('addOtherBrandInput').value)) {
            showToast('Please select or enter a brand', 'error');
            return false;
        }
        
        if (!document.getElementById('addProductPrice').value || parseFloat(document.getElementById('addProductPrice').value) <= 0) {
            showToast('Please enter a valid price', 'error');
            return false;
        }
        
        if (!document.getElementById('addProductStock').value || parseInt(document.getElementById('addProductStock').value) < 0) {
            showToast('Please enter a valid stock quantity', 'error');
            return false;
        }
        
        return true;
    }

    // Set loading state
    function setLoading(isLoading, element = null) {
        state.loading = isLoading;
        
        if (element) {
            if (isLoading) {
                element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                element.disabled = true;
            } else {
                // Restore original content if needed
                // This would need to be handled based on the specific button
                element.disabled = false;
            }
        }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-times-circle' : 
                    type === 'warning' ? 'fa-exclamation-circle' : 'fa-info-circle'
                }"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close">&times;</button>
            <div class="toast-progress">
                <div class="toast-progress-bar"></div>
            </div>
        `;
        
        // Add close button event
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', function() {
            toast.remove();
        });
        
        toastContainer.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    // Show confirmation dialog
    function showConfirmation(title, message, confirmCallback) {
        document.getElementById('confirmationTitle').textContent = title;
        document.getElementById('confirmationMessage').textContent = message;
        
        const confirmBtn = document.getElementById('confirmActionBtn');
        
        // Remove any existing event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.addEventListener('click', function() {
            confirmCallback();
            confirmationModal.classList.remove('active');
        });
        
        confirmationModal.classList.add('active');
    }

    // Initialize charts
    function initializeCharts() {
        // Sales Chart
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        const salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                datasets: [{
                    label: 'Sales',
                    data: [12000, 19000, 15000, 18000, 21000, 25000, 30000],
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Products Chart
        const productsCtx = document.getElementById('productsChart').getContext('2d');
        const productsChart = new Chart(productsCtx, {
            type: 'bar',
            data: {
                labels: ['iPhone 16e', 'Galaxy S25 Ultra', 'MacBook Pro', 'AirPods Pro', 'Smart Watch'],
                datasets: [{
                    label: 'Units Sold',
                    data: [24, 18, 12, 30, 15],
                    backgroundColor: [
                        'rgba(37, 99, 235, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(156, 163, 175, 0.7)'
                    ],
                    borderColor: [
                        'rgba(37, 99, 235, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(156, 163, 175, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Customers Chart
        const customersCtx = document.getElementById('customersChart').getContext('2d');
        const customersChart = new Chart(customersCtx, {
            type: 'doughnut',
            data: {
                labels: ['New Customers', 'Returning Customers', 'Inactive Customers'],
                datasets: [{
                    data: [45, 30, 25],
                    backgroundColor: [
                        'rgba(37, 99, 235, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(239, 68, 68, 0.7)'
                    ],
                    borderColor: [
                        'rgba(37, 99, 235, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        // Revenue by Category Chart
        const revenueCtx = document.getElementById('revenueByCategoryChart').getContext('2d');
        const revenueChart = new Chart(revenueCtx, {
            type: 'pie',
            data: {
                labels: ['Electronics', 'Fashion', 'Home & Living', 'Beauty', 'Others'],
                datasets: [{
                    data: [45000, 28000, 18000, 12000, 8000],
                    backgroundColor: [
                        'rgba(37, 99, 235, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(156, 163, 175, 0.7)'
                    ],
                    borderColor: [
                        'rgba(37, 99, 235, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(156, 163, 175, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: KES ${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Customer Acquisition Chart
        const customerAcqCtx = document.getElementById('customerAcquisitionChart').getContext('2d');
        const customerAcqChart = new Chart(customerAcqCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                datasets: [{
                    label: 'Organic',
                    data: [120, 150, 180, 200, 220, 250, 280],
                    borderColor: 'rgba(37, 99, 235, 1)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Paid',
                    data: [80, 100, 120, 150, 180, 200, 220],
                    borderColor: 'rgba(16, 185, 129, 1)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Product Performance Chart
        const productPerfCtx = document.getElementById('productPerformanceChart').getContext('2d');
        const productPerfChart = new Chart(productPerfCtx, {
            type: 'radar',
            data: {
                labels: ['Sales', 'Revenue', 'Profit', 'Customer Rating', 'Returns'],
                datasets: [{
                    label: 'iPhone 16e',
                    data: [90, 85, 80, 92, 5],
                    backgroundColor: 'rgba(37, 99, 235, 0.2)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(37, 99, 235, 1)'
                },
                {
                    label: 'Galaxy S25 Ultra',
                    data: [85, 80, 75, 88, 8],
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(16, 185, 129, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    r: {
                        angleLines: {
                            display: true
                        },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });
    }

    // Update product
    async function updateProduct() {
        // Validate form
        if (!validateProductForm('edit')) return;
        
        try {
            setLoading(true, document.getElementById('updateProductBtn'));
            
            // Gather product data
            const productData = {
                id: state.currentProductId,
                name: document.getElementById('editProductName').value,
                category: document.getElementById('editProductCategory').value,
                subcategory: document.getElementById('editProductSubcategory').value,
                class: document.getElementById('editProductClass').value,
                brand: document.getElementById('editProductBrand').value === "other" ? 
                    document.getElementById('editOtherBrandInput').value : 
                    document.getElementById('editProductBrand').value,
                price: parseFloat(document.getElementById('editProductPrice').value),
                discount: parseInt(document.getElementById('editProductDiscount').value) || 0,
                stock: parseInt(document.getElementById('editProductStock').value),
                status: document.getElementById('editProductStatus').value,
                badge: document.getElementById('editProductBadge').value,
                description: document.getElementById('editProductDescription').value,
                features: Array.from(document.querySelectorAll('#addFeaturesEditList .feature-tag span')).map(el => el.textContent),
                hasVariants: document.getElementById('editHasVariantsToggle').checked,
                variants: []
            };
            
            // If product has variants, gather variant data
            if (productData.hasVariants) {
                const colorVariants = document.querySelectorAll('#editColorVariantsContainer .color-variant');
                colorVariants.forEach(colorVariant => {
                    const colorName = colorVariant.querySelector('.color-name').textContent;
                    const sizes = Array.from(colorVariant.querySelectorAll('.sizes-list .size-tag span')).map(el => el.textContent);
                    
                    productData.variants.push({
                        color: colorName,
                        sizes: sizes
                    });
                });
            }
            
            // Send to server
            const response = await fetch('/crud/update-merchant-product', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update product');
            }
            
            const updatedProduct = await response.json();
            
            // Update local state
            const productIndex = state.products.findIndex(p => p.id === state.currentProductId);
            if (productIndex !== -1) {
                state.products[productIndex] = updatedProduct;
                populateProductsTable();
            }
            
            showToast('Product updated successfully!', 'success');
            editProductModal.classList.remove('active');
            
        } catch (error) {
            showToast(`Error updating product: ${error.message}`, 'error');
            console.error('Error updating product:', error);
        } finally {
            setLoading(false, document.getElementById('updateProductBtn'));
        }
    }

    // Validate product form (edit mode)
    function validateProductForm(mode = 'add') {
        const prefix = mode === 'add' ? 'add' : 'edit';
        
        // Basic validation - you can expand this
        if (!document.getElementById(`${prefix}ProductName`).value) {
            showToast('Please enter a product name', 'error');
            return false;
        }
        
        if (!document.getElementById(`${prefix}ProductCategory`).value) {
            showToast('Please select a category', 'error');
            return false;
        }
        
        if (!document.getElementById(`${prefix}ProductSubcategory`).value) {
            showToast('Please select a subcategory', 'error');
            return false;
        }
        
        if (!document.getElementById(`${prefix}ProductClass`).value) {
            showToast('Please select a class', 'error');
            return false;
        }
        
        if (!document.getElementById(`${prefix}ProductBrand`).value || 
            (document.getElementById(`${prefix}ProductBrand`).value === "other" && 
             !document.getElementById(`${prefix}OtherBrandInput`).value)) {
            showToast('Please select or enter a brand', 'error');
            return false;
        }
        
        if (!document.getElementById(`${prefix}ProductPrice`).value || 
            parseFloat(document.getElementById(`${prefix}ProductPrice`).value) <= 0) {
            showToast('Please enter a valid price', 'error');
            return false;
        }
        
        if (!document.getElementById(`${prefix}ProductStock`).value || 
            parseInt(document.getElementById(`${prefix}ProductStock`).value) < 0) {
            showToast('Please enter a valid stock quantity', 'error');
            return false;
        }
        
        return true;
    }

    // Initialize color picker
    function initializeColorPicker() {
        const colorOptions = document.querySelectorAll('.color-option');
        
        colorOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Update theme preview
                const color = this.getAttribute('data-color');
                document.querySelector('.theme-preview-header').style.backgroundColor = color;
            });
        });
    }

    // Initialize the color picker
    initializeColorPicker();

    // Add event listener for update product button
    document.getElementById('updateProductBtn').addEventListener('click', updateProduct);

    // Add event listener for edit product form dropdowns
    const editProductCategory = document.getElementById('editProductCategory');
    const editProductSubcategory = document.getElementById('editProductSubcategory');
    const editProductClass = document.getElementById('editProductClass');
    const editProductBrand = document.getElementById('editProductBrand');
    const addOtherBrandEditInput = document.getElementById('editOtherBrandInput');

    editProductCategory.addEventListener('change', function() {
        // Clear and disable subcategory dropdown
        editProductSubcategory.innerHTML = '<option value="">Select Subcategory</option>';
        editProductSubcategory.disabled = true;
        
        // Clear and disable class dropdown
        editProductClass.innerHTML = '<option value="">Select Class</option>';
        editProductClass.disabled = true;
        
        // Clear and disable brand dropdown
        editProductBrand.innerHTML = '<option value="">Select Brand</option>';
        editProductBrand.disabled = true;
        addOtherBrandEditInput.style.display = 'none';
        
        // Find selected category
        const selectedCategory = categoriesData.categories.find(cat => cat.category === this.value);
        
        if (selectedCategory) {
            // Populate subcategories
            selectedCategory.subcategories.forEach(subcat => {
                const option = document.createElement('option');
                option.value = subcat.subcategory;
                option.textContent = subcat.subcategory;
                editProductSubcategory.appendChild(option);
            });
            
            editProductSubcategory.disabled = false;
        }
    });

    editProductSubcategory.addEventListener('change', function() {
        // Clear and disable class dropdown
        editProductClass.innerHTML = '<option value="">Select Class</option>';
        editProductClass.disabled = true;
        
        // Clear and disable brand dropdown
        editProductBrand.innerHTML = '<option value="">Select Brand</option>';
        editProductBrand.disabled = true;
        addOtherBrandEditInput.style.display = 'none';
        
        // Find selected category and subcategory
        const selectedCategory = categoriesData.categories.find(cat => cat.category === editProductCategory.value);
        if (selectedCategory) {
            const selectedSubcategory = selectedCategory.subcategories.find(sub => sub.subcategory === this.value);
            
            if (selectedSubcategory) {
                // Populate classes
                selectedSubcategory.classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    editProductClass.appendChild(option);
                });
                
                editProductClass.disabled = false;
            }
        }
    });

    editProductClass.addEventListener('change', function() {
        // Clear and disable brand dropdown
        editProductBrand.innerHTML = '<option value="">Select Brand</option>';
        editProductBrand.disabled = true;
        addOtherBrandEditInput.style.display = 'none';
        
        // Get brands for selected class
        const brands = brandsData[this.value];
        
        if (brands) {
            // Populate brands
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                editProductBrand.appendChild(option);
            });
            
            // Add "Other" option
            const otherOption = document.createElement('option');
            otherOption.value = "other";
            otherOption.textContent = "Other";
            editProductBrand.appendChild(otherOption);
            
            editProductBrand.disabled = false;
        }
    });

    editProductBrand.addEventListener('change', function() {
        if (this.value === "other") {
            addOtherBrandEditInput.style.display = 'block';
        } else {
            addOtherBrandEditInput.style.display = 'none';
        }
    });

    // Product variants toggle for edit form
    const editHasVariantsToggle = document.getElementById('editHasVariantsToggle');
    const editVariantsContainer = document.getElementById('editVariantsContainer');

    editHasVariantsToggle.addEventListener('change', function() {
        editVariantsContainer.style.display = this.checked ? 'block' : 'none';
    });

    // Add color variant for edit form
    const addColorEditBtn = document.getElementById('addColorEditBtn');
    addColorEditBtn.addEventListener('click', addColorVariant);

    // Add product feature for edit form
    const editFeatureBtn = document.getElementById('editFeatureBtn');
    editFeatureBtn.addEventListener('click', function() {
        const editFeatureInput = document.getElementById('editFeatureInput');
        const feature = editFeatureInput.value.trim();
        const featuresList = document.getElementById('addFeaturesEditList');
        
        if (feature) {
            const featureTag = document.createElement('div');
            featureTag.className = 'feature-tag';
            featureTag.innerHTML = `
                <span>${feature}</span>
                <button class="delete-feature">
                    <i class="fas fa-times"></i>
                </button>
            `;
            featuresList.appendChild(featureTag);
            editFeatureInput.value = '';
            
            // Add event listener for delete feature button
            const deleteFeatureBtn = featureTag.querySelector('.delete-feature');
            deleteFeatureBtn.addEventListener('click', function() {
                featureTag.remove();
            });
        }
    });

    // Setup image upload for edit form
    const editImageUploadArea = document.getElementById('editImageUploadArea');
    const editProductImagesInput = document.getElementById('editProductImages');
    const editImagesPreviewContainer = document.getElementById('editImagesPreviewContainer');

    editImageUploadArea.addEventListener('click', function() {
        editProductImagesInput.click();
    });

    editImageUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--primary)';
        this.style.backgroundColor = 'var(--primary-light)';
    });

    editImageUploadArea.addEventListener('dragleave', function() {
        this.style.borderColor = 'var(--border-color)';
        this.style.backgroundColor = '';
    });

    editImageUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = 'var(--border-color)';
        this.style.backgroundColor = '';
        
        if (e.dataTransfer.files.length > 0) {
            editProductImagesInput.files = e.dataTransfer.files;
            handleImageUpload(editProductImagesInput.files, editImagesPreviewContainer);
        }
    });

    editProductImagesInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleImageUpload(this.files, editImagesPreviewContainer);
        }
    });

    // Setup video upload for edit form
    const editVideoUploadArea = document.getElementById('addVideoEditUploadArea');
    const editProductVideoInput = document.getElementById('editProductVideo');
    const editVideoPreviewContainer = document.getElementById('editVideoPreviewContainer');

    editVideoUploadArea.addEventListener('click', function() {
        editProductVideoInput.click();
    });

    editProductVideoInput.addEventListener('change', function() {
        if (this.files.length > 0 && this.files[0].type.startsWith('video/')) {
            const file = this.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                editVideoPreviewContainer.innerHTML = '';
                const preview = document.createElement('div');
                preview.className = 'media-preview';
                preview.innerHTML = `
                    <video controls>
                        <source src="${e.target.result}" type="${file.type}">
                        Your browser does not support the video tag.
                    </video>
                    <button class="delete-media">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                editVideoPreviewContainer.appendChild(preview);
                
                // Add event listener for delete button
                const deleteBtn = preview.querySelector('.delete-media');
                deleteBtn.addEventListener('click', function() {
                    preview.remove();
                    editProductVideoInput.value = '';
                });
            };
            reader.readAsDataURL(file);
        }
    });

    // Handle image upload (generic function for both add and edit forms)
    function handleImageUpload(files, previewContainer) {
        // Clear existing previews if needed
        previewContainer.innerHTML = '';
        
        // Limit to 7 images
        const filesToUpload = Array.from(files).slice(0, 7);
        
        filesToUpload.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'media-preview';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Product Image">
                        <button class="delete-media">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(preview);
                    
                    // Add event listener for delete button
                    const deleteBtn = preview.querySelector('.delete-media');
                    deleteBtn.addEventListener('click', function() {
                        preview.remove();
                    });
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Set current product ID when editing
    function setCurrentProductId(id) {
        state.currentProductId = id;
    }

    // Set current order ID when viewing/updating
    function setCurrentOrderId(id) {
        state.currentOrderId = id;
    }
});





        </script>
    </body>
</html>